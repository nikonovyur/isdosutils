; Утилита mkdir - создание каталога; При вызове без параметров создаёт каталог в интерактивном режиме       ORG  #61A8        ; 25000	LD   C,#33	RST  #10       EXX	LD   A,D       CP   #6           ; Проверка уровня вложенности текущего каталога	INC  A       RET  NC           ; Если 6, или больше - выход с шибкой	XOR  A       LD   IX,L6388     ; Сохраняем значение текущего устройства (4 байта) в памяти	LD   C,#36	RST  #10L6281  LD   C,#43       RST  #10       JP   C,L626B       JR   NZ,L61BF       EXX       OR   A       JR   Z,L62C1     ; A=0 обнаружен путь, иначе - ключ       RES  5,A       CP   #53         ; Проверка на ключ /S - размер каталога       JR   Z,L62AE       LD   C,#40       CP   #43         ; Проверка на ключ /C - непрерывный каталог       JR   Z,L62A6       LD   C,#80       CP   #50         ; Проверка на ключ /P - защищенный       JR   Z,L62A6       CP   #46         ; Проверка на ключ /F - не сохранять кэш       JR   Z,L62D0       LD   C,#10       CP   #48         ; Проверка на ключ /H - скрытый       JR   NZ,L6281; Непрерывный каталог, поднимаем 6-й бит в байте флагов; Или защищенный каталог, поднимаем 7-й битL62A6  LD   HL,L62E0       LD   A,C       OR   (HL)       LD   (HL),A       JR   L6281; Получаем число, следующее за ключом /s, (кол-во блоков) помещаем его в дескрипторL62AE  INC  HL           ; #61E9       INC  HL       XOR  A       LD   BC,#0A7D     ; Преобразование строки в число       RST  #10       JP   C,L626B       EXX       LD   A,L       DEC  A       AND  #0F       INC  A       LD   (L62E4),A    ; Кладем число в дескриптор       LD   C,#43       RST  #10       JP   C,L626B       JR   L6281L62C1  LD   DE,L62D5       LD   BC,#0008       LDIR              ; копируем имя каталога в будущий дескриптор       LD   HL,L61C0       SET  0,(HL)       JR   L6281L62D0  LD   (L6264),A       JR   L6281;       JP   C,L626B      ; Что-то пошло не так, идем на выход; Сюда будет вписана #01, если режим командной строки без окнаL61BF  LD   A,#0L61C0	EQU	$-#1       RRA       JR   C,L6237      ; Переход, если командная строка, иначе - рисуем окно       LD   IX,L621B       LD   A,(L621A)    ; В вектор окна помещаем цвет окна из дескриптора UnCo       LD   (IX+#04),A       LD   A,(SHADOW)       LD   (IX+#05),A       LD   A,#01       LD   C,#61        ; Рисуем окно	RST  #10       LD   C,#66       RST  #10; Подсвечиваем строку ввода       LD   D,(IX+#00)       LD   E,(IX+#03)       LD   (IX+#00),2       LD   (IX+#03),27       LD   A,2       LD   HL,LINECO       LD   B,(HL)       LD   C,#64       RST  #10       LD   (IX+#03),E       LD   (IX+#00),D; Забиваем имя каталога пробелами       LD   HL,L62DD       LD   B,#08L61ED	DEC  HL	LD   (HL),#20       DJNZ L61EDL61F2	EX   DE,HL; Установка координат печати в окне       LD   HL,#0201	LD   C,#6B	RST  #10; Строковый мобильный редактор	EX   DE,HL       LD   A,#08       LD   DE,#0A01       LD   BC,#016E	RST  #10       JR   NZ,L6211  ; Выход по спец. клавише. На выход	OR   A       JR   Z,L6211   ; Введено 0 символов. На выход; Проверяем корректность имени       LD   A,#20     ; Признак каталога	LD   C,#50	RST  #10       JR   C,L61F2   ; Имя некорректно - назад в редактор       JR   L624E     ; Всё готово к созданию - идём дальшеL6211	XOR  A       LD   A,#F4       RET       DEFM "UnCo"       DEFB #03L621A  DEFB #38LINECO DEFB %00101000SHADOW DEFB #01; Дополнительные проверки командной строкиL6237  LD   HL,L62D5     ; Адрес буфера с именем каталога	LD   B,#8	PUSH HL	LD   A,#FFL623F	AND  (HL)	INC  HL	DJNZ L623F	POP  HL	INC  A       JP   Z,L626B      ; Если буфер забит символами #ff, то на выход; В случае командной строки корректируем имя каталога в буфере       LD   A,#20        ; признак каталога	LD   C,#50	RST  #10       JP   C,L626B      ; ошибка - на выходL624E  LD   C,#45        ; точка перехода после ввода имени в окне	RST  #10; В регистр BC получаем системную дату       EXX	DEC  HL	DEC  HL	LD   B,(HL)	DEC  HL	LD   C,(HL)       LD   (L62F3),BC   ; Кладём дату в дескриптор	LD   HL,L62D5; Процедура создания, HL' - адрес дескриптораL62F5  LD   C,#23        ; Создаём каталог       RST  #10       JP   C,L626B       EXX       LD   BC,#000B       ADD  HL,BC       LD   A,(HL)       ; A - регистр состояния       LD   C,#6       ADD  HL,BC       LD   E,(HL)       INC  HL       LD   D,(HL)       ; DE - номер блока описателя сегментов       AND  #40          ; Проверка 6-го бита непрерывный ли файл?       JR   NZ,L6313     ; каталог непрерывный - переходим       RST  #10          ; блок номер DE считываем в кэш       JP   C,L626B       EXX       INC  HL       LD   E,(HL)       INC  HL       LD   D,(HL)       PUSH DE       EXX       POP  DEL6313  INC  HL       LD   (HL),E       INC  HL       LD   (HL),D       LD   C,#28       RST  #10       JR   C,L626B       PUSH DE       LD   BC,LFFEC       ADD  HL,BC       LD   BC,DSCRLN       LD   DE,L62D5       LDIR             ; копируем в локальный дескриптор внутренний дескриптор с обновлёнными данными       LD   C,#10       ; далее заполняем дескриптор дефолтным содержимым (1 элемент каталога и т.д. )       ADD  HL,BC       LD   A,(HL)       INC  HL       INC  HL       INC  HL       LD   E,(HL)       INC  HL       LD   D,(HL)       INC  HL       INC  HL       INC  HL       OR   (HL)       INC  A       LD   (L62E1),DE       LD   (L62EC),A       LD   A,#1       LD   (L62EA),A       POP  DE       LD   C,#6        ; считываем первый блок каталога       RST  #10       JR   C,L626B       EXX       PUSH DE       EX   DE,HL       LD   HL,L62D5       LD   BC,DSCRLN       LDIR             ; заполняем первый элемент каталога своим же дескриптором       LD   C,#DF       LD   L,E       LD   H,D       INC  DE       LD   (HL),#0       LDIR             ; остальная часть блока - нули       POP  DE       LD   C,#2E       ; помечаем блок в кэше как модифицированный       RST  #10       JR   C,L626B; В регистре A - вычисляем количество блоков, подлежащих забивке нулями       LD   HL,(L62E3)       LD   A,L       OR   A       LD   A,H       JR   NZ,L636A       DEC  AL636A  OR   A       JR   Z,L6263       LD   B,A       LD   DE,#0001; цикл забивки нулями блоков каталога, следующих за первымL6370  LD   C,#2D      ; читаем блок в кэш       RST  #10       JR   C,L626B       EXX             ; получаем в HL' адрес блока в кэше       XOR  A       LD   B,AL6377  LD   (HL),A     ; пишем в блок нули       INC  HL       DJNZ L6377       PUSH DE       EXX       POP  HL       EX   DE,HL       LD   C,#2E      ; помечаем блок в кэше как модифицированный       RST  #10       JR   C,L626B       EX   DE,HL       INC  DE       DJNZ L6370; Если не 0 - не сбрасываем буфер, иначе - сбрасываем; Сюда пишут, если есть флаг /fL6263  LD   A,#0L6264	EQU	$-#1	OR   A	JR   NZ,L626B	LD   C,#2	RST  #10; Очень хитрый выход с восстановлением среды и открытием устройстваL626B  PUSH AF       XOR  A	LD   IX,L6388       LD   C,#37       ; восстанавливаем заранее сохранённyю среду	RST  #10	POP  BC	RET  C	PUSH BC	POP  AF	RET  C       LD   C,#43       ; открывает устройство и каталог по пути, содержащемся во внутреннем буфере командной строки	RST  #10	RET  C	XOR  A       LD   A,#F2       RET; Вектор окнаL621B  DEFB #01       DEFB #09       DEFB #05       DEFB #1D       DEFB #38       DEFB #01       DEFB #03       DEFB #23       DEFM "╔═══════ Создание каталога ═══════╗";       DEFB #0D       DEFM "║                                 ║";       DEFB #0D       DEFM "╚═════════════════════════════════╝"       DEFB #03; Дескриптор каталогаL62D5  DEFB "C"       DEFB "A"       DEFB "T"       DEFB "A"       DEFB "L"       DEFB "O"       DEFB "G"       DEFB " "L62DD  DEFB #20       DEFB #20       DEFB #20L62E0  DEFB #21L62E1  DEFB #00       DEFB #00L62E3  DEFB #00L62E4  DEFB #03       DEFB #00       DEFB #00       DEFB #00       DEFB #00       DEFB #00L62EA  DEFB #00       DEFB #00L62EC  DEFB #00       DEFB #00       DEFB #00       DEFB #00       DEFB #00       DEFB #00       DEFB #00L62F3  DEFB #00       DEFB #00DSCRLN EQU  $-L62D5L6388  DEFB #00       DEFB #00       DEFB #00       DEFB #00LFFEC	EQU	#FFEC