	ORG  #C350LB	EQU	#BL100	EQU	#100L7753	EQU	#7753	DEFB	#00	DEFB	#00	DEFB	#00	DEFB	#00       LD   HL,LC424     ; буфер имени файла заполнили #FF	LD   B,#BLC359	LD   (HL),#FF	INC  HL	DJNZ LC359	XOR  A	LD   (LC3E9),A	LD   (LC466),A       LD   C,#52        ; берём параметр (это имя резидента) и получаем в A номер его канала	RST  #10	RET  C       LD   (LC414),A    ; номер канала резидента	LD   A,#25       SCF       RET  NZ           ; выход в случае ошибкиLC370  LD   C,#45        ; адреса системных векторов уровня COM	RST  #10       EXX       LD   BC,#FFFB	ADD  HL,BC       LD   (LC41A),HL   ; адрес указателя в командной строке	LD   C,(HL)	INC  HL	LD   B,(HL)	LD   (LC416),BC       LD   C,#43        ; получаем параметр ком. строки, должно быть имяфайла/маска	RST  #10	RET  C	EX   AF,AF'       LD   A,(LC466)    ; в начале там 0	EX   AF,AF'       JR   NZ,LC3C8     ; ошибка       EXX	OR   A       JR   Z,LC3B5      ; обнаружен файл/маскаLC391  INC  HL           ; ключ - HL - адрес символа /       LD   A,(HL)       ; грузим ключ	INC  HL       RES  5,A	LD   C,#4       CP   #5A          ; ключ /Z - подбор файлов по отметке	JR   Z,LC3A8	LD   C,#20       CP   #58          ; ключ /X - подбор каталогов	JR   Z,LC3A8	LD   C,#1       CP   #59          ; ключ /Y - подбор удалённых файлов       JR   NZ,LC3C8     ; переход, если ключ не XYZLC3A8  EX   AF,AF'       ; C=#4 /Z, C=#1 /Y, C=#20 /X ; A - регистр состояния	OR   CLC3AA  LD   (LC466),A    ; в регистр отметили обнаруженый флаг соответствующим битом, сохранили	EX   AF,AF'       LD   A,#2F        ; символ /       CP   (HL)       JR   NZ,LC370     ; не / - переход на поиск следующего параметра       JR   LC391        ; / - переход на исследование какой ключLC3B5  EX   AF,AF'       ; параметр - файл/маска       LD   B,A       AND  #84          ; в регистре состояния проверяем биты 2,7       LD   A,B       JR   NZ,LC3C9     ; переход, если требуются файлы по отметке, или загружен в буфер файл/маска       SET  7,A          ; поднимаем 7 бит в регистре состояния, копируем параметр - имя файла в буфер	LD   DE,LC424	LD   BC,LB       LDIR              ; копируем имя файла в буфер	JR   LC3AALC3C8  EX   AF,AF'       ; переход сюда, если ключ не XYZLC3C9	BIT  2,A	JR   NZ,LC3D4       BIT  7,A          ; проверяем, что скопировано имя файла в буфер	JR   NZ,LC437       OR   #FF          ; иначе - выход       RETLC3D4  LD   C,#87        ; переход сюда, если поднят 2 бит	RST  #10	OR   A	JR   NZ,LC3E8	LD   C,#8A	RST  #10	OR   A	RET  Z	LD   D,#0	LD   E,A	CALL LC42F	DEC  HL	SET  0,(HL)LC3E8	LD   A,#0LC3E9	EQU	$-#1	INC  A	LD   (LC3E9),A	LD   B,A	LD   E,#0LC3F1	INC  E	LD   A,#80       CP   E       RET  Z	PUSH BC	CALL LC42F	POP  BC	DEC  HL	LD   A,(HL)	CP   B	JR   NZ,LC3F1	CALL LC406	RET  C	JR   LC3E8LC406  LD   A,E          ; в E - номер открываемого файла в каталоге       LD   C,#26        ; открыть файл по номеру в A	RST  #10	POP  BC       JR   C,LC453      ; что-то пошло не так, на выход	PUSH BC       EXX	CALL LC458	RET  NZ       LD   A,#FF        ; номер канала вызываемого резидентаLC414	EQU	$-#1	LD   BC,0LC416  EQU  $-#2         ; текущий адрес в командной строке должен указывать на файл/шаблон	LD   (0),BCLC41A  EQU  $-#2         ; указатель в командной строке	LD   DE,LC424       LD   BC,L7753     ; вызов резидента и возврат	RST  #10       RETLC424	DEFB	#00	DEFB	#00	DEFB	#00	DEFB	#00	DEFB	#00	DEFB	#00	DEFB	#00	DEFB	#00	DEFB	#00	DEFB	#00	DEFB	#00LC42F	LD   C,#86	RST  #10       EXX	PUSH HL       EXX	POP  HL       RETLC437  LD   DE,L100      ; переход сюда, если в регистре состояния поднят 7 бит (загрузили имя файла)LC43A	INC  E       LD   C,#27        ; читаем в кэш блок каталога, содержащий файловый дескриптор номер в E	RST  #10	JR   C,LC453	PUSH DE       EXX               ; HL указывает на описатель файла в кэше       LD   DE,LC424     ; DE - трафарет 11 байт       LD   C,#8F        ; сравнение 11 байт по адресам HL и DE	RST  #10	POP  DE       JR   NZ,LC43A     ; файл не подошёл, переходим к следующему	PUSH DE       CALL LC406        ; файл подошёл - работа с файлом	POP  DE	RET  C	JR   LC43A; ошибка. В регистре A её кодLC453  CP   #50          ; 80 - каталог закончился       RET  Z            ; возврат без ошибки       SCF               ; иначе что-то серьёзное       RETLC458  PUSH HL           ; файл открыт, надо сделать вызов по работе с файлом	LD   BC,LB	ADD  HL,BC	LD   A,(HL)       INC  A            ; проверяем FSTAT файла на FF       JR   Z,LC46A      ; если FF, вызов не делаем	DEC  A	AND  #21	LD   C,A	LD   A,#0LC466  EQU  $-#1         ; регистр состояния, в нём отмечаются биты, сответсвующие ключам	AND  #21	XOR  CLC46A	DEC  A	POP  HL       RET