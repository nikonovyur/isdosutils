       .GLOB RECD10, PGRD10, PGWR10, BLUMFW, BLUMFR, FDREAD       .GLOB PUSW, FRDFLG, FDWRI, FDSTT, FSTBLK, FSTBL1       .GLOB CRLVL, FNLVL, PGWRI, PGRDR, PGLST, PGFRE       .GLOB BUFBLK, L64FD, BUFSIZ, FDEND, FDNXT       .GLOB FDCUR, L60BE, FLWOFS, DSTWIN, DESTWN       .GLOB L62FC, L62FD, DSKLET, SRCTXT, DSTTXT, DSTXLN       .GLOB L5DC3, BLNKWN, DSTFLG, L6020, L5F53       .GLOB L6555, OVEXT, DEMD, BLKSM, BLKRD, BLKWR       .GLOB PRBR, MWINV, MVPRBR       .GLOB MVFRPT, MVTOPT, FNBUF, LTSWN, WRFRFL, WRTOFL       .GLOB LTSWCL, FLPTST, PRSW, L653D, L5FE0, L5FE6       .GLOB CLDSR, CLDDS, CLCLR; подпрограмма возвращает адрес, где лежит номер файла в каталоге; на текущем уровнеRECD10       LD   HL,CRLVL       LD   C,(HL)       INC  HL       LD   B,(HL)       LD   HL,FNLVL       ADD  HL,BC       RET; подпрограмма возвращает адрес номера страницы памяти; в режиме записиPGWR10       LD   HL,PGWRI       JR   PGRD11; то же самое для чтенияPGRD10       LD   HL,PGRDRPGRD11       LD   C,(HL)       INC  HL       LD   B,(HL)       LD   HL,PGLST       ADD  HL,BC       RET; подпрограмма вычисляет количество свободных блоков; в расширенной памятиBLUMFW                  ; для записи       LD   A,(PGWRI)       JR   BLUM01BLUMFR                  ; для чтения       LD   A,(PGRDR)   ; ниже - подсчёт свободных блоков в расширенной памятиBLUM01       LD   HL,#0000       LD   B,A       LD   A,4       SUB  B       RET  C       LD   B,A       LD   DE,#0040       JR   Z,2$1$       ADD  HL,DE       DJNZ 1$2$       LD   A,(PGFRE)       LD   E,A       ADD  HL,DE       RET; подпрограмма читает текущий дескриптор открытого файла; в массив дескрипторовFDREAD       PUSH HL       LD   HL,(FDEND)       LD   DE,(FDNXT)       OR   A       SBC  HL,DE       POP  HL       JR   Z,3$       RET  C       LD   (FDCUR),DE       LD   BC,#000C       LDIR             ; в область дескрипторов копируем дескриптор копируемого файла       DEC  DE       EX   DE,HL       LD   A,(L60BE)       BIT  6,(HL)      ; проверяем сегментированный/непрерывный       JR   Z,1$        ; сегментированный - переходим       BIT  2,A         ; проверка ключа /S       JR   Z,2$       RES  6,(HL)       JR   2$1$       BIT  1,A         ; проверка ключа /C       JR   Z,2$       EX   DE,HL       PUSH HL       LD   BC,#0004       ADD  HL,BC       LD   A,(HL)      ; смотрим старший байт длины в дескрипторе       OR   A           ; если не 0-файл непрерывным не делаем       POP  HL       EX   DE,HL       JR   NZ,2$       SET  6,(HL)2$       EX   DE,HL       LD   BC,#0014       INC  DE       LDIR              ; копируем остальные 20 байт дескриптора из кэша       LD   (FDNXT),DE       EX   DE,HL        ; обнуляем байт по смещению +25       LD   DE,#0007       XOR  A       SBC  HL,DE       LD   (HL),A       RET3$       SCF       RET; подпрограмма выгрузки буфера в расширенную память; выход: Z-память заполнена, NZ-место ещё естьPRSW       CALL PGRD10       LD   A,(HL)       OR   A;       JP   Z,PRRCF       ; забиты все страницы, забита память, пора писать       RET  Z       LD   A,(PGFRE)       LD   B,A       LD   A,#40       SUB  B       LD   D,A       LD   E,#00       LD   HL,#C000       ADD  HL,DE       PUSH HL            ; вычислили адрес куда копировать       LD   A,(BUFBLK)       LD   D,A       LD   HL,(L64FD)       ADD  HL,DE       PUSH HL            ; адрес откуда копировать       LD   C,A       LD   A,(BUFSIZ)       SUB  C       CP   B       JR   NC,1$       LD   B,A1$       LD   C,#00       POP  HL       POP  DE       PUSH BC       EXX       CALL PGRD10       LD   A,(HL)       LD   BC,#7FFD       DI       OUT  (C),A       EXX       LDIR       EXX       LD   A,#10       OUT  (C),A       EI       EXX       POP  BC          ; B-количество скопированных блоков       LD   A,(PGFRE)       SUB  B       JR   NZ,2$       LD   HL,PGRDR    ; выбрали всю страницу, переходим на новую       INC  (HL)       LD   A,#402$       LD   (PGFRE),A       LD   A,(BUFSIZ)       LD   C,A       LD   A,(BUFBLK)       ADD  A,B         ; считаем, на сколько расчистили буфер в памяти       LD   (BUFBLK),A       CP   C       JR   C,PRSW      ; если не весь, идём на следующую итерацию копирования       XOR  A       INC  A       RET; подпрограмма заполнения буфера из расширенной памяти; входной параметр: A=0-копирование ldir,; A<>0-обмен с памятью размером в буферPUSW       LD   (EXFLG),A       XOR  A       LD   (BUFBLK),A3$       LD   A,(PGFRE)       LD   B,A       LD   A,#40       SUB  B       LD   D,A       LD   E,#00       LD   HL,#C000       ADD  HL,DE       PUSH HL            ; вычислили адрес откуда копировать       LD   A,(BUFBLK)       LD   D,A       LD   HL,(L64FD)       ADD  HL,DE       PUSH HL            ; адрес куда копировать       LD   C,A       LD   A,(BUFSIZ)       SUB  C       CP   B       JR   NC,2$       LD   B,A2$       LD   C,#00       POP  DE       POP  HL       PUSH BC       EXX       CALL PGWR10       LD   A,(HL)       LD   BC,#7FFD       DI       OUT  (C),A       EXX       LD   A,(EXFLG)       OR   A       JR   NZ,4$       LDIR       JR   5$4$       LD   A,(DE)       EX   AF,AF'       LD   A,(HL)       LD   (DE),A       EX   AF,AF'       LD   (HL),A       INC  HL       INC  DE       DEC  BC       XOR  A       OR   B       OR   C       JR   NZ,4$5$       EXX       LD   A,#10       OUT  (C),A       EI       EXX       POP  BC          ; B-количество скопированных блоков       LD   A,(PGFRE)       SUB  B       JR   NZ,1$       LD   HL,PGWRI    ; выбрали всю страницу, переходим на новую       INC  (HL)       LD   A,#401$       LD   (PGFRE),A       LD   A,(BUFSIZ)       LD   C,A       LD   A,(BUFBLK)       ADD  A,B       LD   (BUFBLK),A       CP   C       JR   C,3$        ; если не весь, идём на следующую итерацию копирования       LD   A,(BUFSIZ)       LD   (BUFBLK),A       RETEXFLG  DEFB #00; подпрограмма считает смещение записи; в зависимости от флагов и переменных; вход - всё в переменных; выход - DE - смещениеFLWOFS       LD   A,(FRDFLG)       OR   A       JR   Z,1$       LD   DE,(FSTBL1)       RET1$       LD   HL,(FDWRI)       LD   DE,(FDSTT)       OR   A       SBC  HL,DE       LD   DE,#0000       RET  NZ         ; если дескриптор первый, используем переменную FSTBLK       LD   DE,(FSTBLK)       RET; подпрограмма, выводящая окна "вставьте диск"; A=0 диск ИСТОЧНИК, A<>0 диск ПРИёМНИКDSTWIN       LD   (DSTINP),A       PUSH AF       OR   A       LD   A,(CLDSR)       JR   Z,1$       LD   A,(CLDDS)1$       LD   IX,DESTWN       LD   (IX+#04),A       LD   A,#01       LD   C,#61       RST  #10       LD   C,#66       RST  #10       LD   A,#01       LD   C,#0B       RST  #10       LD   HL,#010D       LD   C,#6B       RST  #10       POP  AF       PUSH AF       OR   A       LD   HL,L62FC       JR   Z,2$       LD   HL,L62FD2$       LD   A,"A"       ADD  A,(HL)       LD   (DSKLET + 1),A       LD   HL,DSKLET       LD   B,#03       LD   C,#6D       RST  #10       LD   HL,#0304       LD   C,#6B       RST  #10       POP  AF       OR   A       LD   HL,SRCTXT       JR   Z,3$       LD   HL,DSTTXT3$       LD   B,DSTXLN       LD   C,#6D       RST  #10       XOR  A       LD   C,#0B       RST  #104$       LD   C,#08       RST  #10       DEC  C       RST  #10       CP   #0D       JR   Z,5$       CP   #10       JP   Z,OVEXT       JR   4$5$       LD   IX,DESTWN       CALL BLNKWN       LD   A,(DSTFLG)       OR   A       RET  NZ       LD   C,#0F       RST  #10       JR   NC,6$       CP   #09       SCF       RET  NZ       CALL L5FE0       JR   8$6$       CALL L6555       LD   HL,L5F53       LD   C,#4B       RST  #10       JR   NC,7$       CP   #51       SCF       RET  NZ       CALL L5FE68$       LD   A,(DSTINP)       JP   DSTWIN7$       LD   C,#33       RST  #10       EXX       LD   (L6020),HL       EXX       LD   A,#01       LD   (DSTFLG),A       RETDSTINP DEFB #00; Подпрограмма удаления пустого каталогаDEMD       CALL RECD10       LD   A,(HL)      ; в A номер файла (каталога) из которого только что вышли       LD   C,#26       RST  #10       RET  C       EXX       PUSH HL       LD   BC,#000B       ADD  HL,BC       LD   (FDFST),HL       POP  HL       LD   DE,0         ; читаем блок #0000 открытого файла (каталога) в кэш       LD   C,#2D       RST  #10          ; HL' - адрес блока в кэше, DE - адрес заголовка блока       RET  C       EXX       LD   (CHDES),DE       LD   (BL0HL),HL       PUSH HL       LD   BC,#000B       ADD  HL,BC       ADD  HL,BC       LD   A,(HL)       ; читаем число файлов без каталога и удалённых       POP  HL           ; восстанавливаем HL - указывает на начало дескриптора самого себя в 0-м блоке каталога       OR   A            ; проверяем количество файлов на 0       JR   Z,1$         ; файлов в каталоге не 0 - переходим       SCF       LD   A,83         ; после прохода удаления файлов, какие-то остались       RET               ; вылетаем с ошибкой1$       ADD  HL,BC       BIT  7,(HL)       JR   Z,2$         ; каталог не защищён, можно удалять       SCF       LD   A,89         ; выход с ошибкой "файл защищён от удаления"       RET2$       LD   HL,(BL0HL)       LD   BC,#000B       ADD  HL,BC       RES  0,(HL)       ; помечаем каталог в 0-м блоке, как удалённый       EXX       LD   HL,(FDFST)       RES  5,(HL)       ; сбрасываем 5-й бит в системном дескрипторе. Теперь он файл.       LD   BC,#0005       ADD  HL,BC       LD   (HL),B       ; обнуляем старший байт размера каталога (файла)       EXX       LD   DE,(CHDES)       LD   C,#2E        ; DE - адрес описателя блока в кэше - помечаем блок как модифицированный       RST  #10       RET  C       LD   C,#3C       RST  #10       RET  C       LD   C,#02       RST  #10       RETFDFST  DEFW #0000BL0HL  DEFW #0000CHDES  DEFW #0000; подпрограмма вычисляет и рисует прогресс-барPRBR       LD   A,"░"       LD   B,PBLEN       CALL PRDR       LD   HL,(BLKRD)       CALL PBCLC       LD   B,A       LD   A,"▒"       CALL PRDR       LD   HL,(BLKWR)       CALL PBCLC       LD   B,A       LD   A,"█"       CALL PRDR       LD   IX,MWINV       LD   HL,#0407       LD   C,#6B       RST  #10       LD   HL,MVPRBR       LD   B,PBLEN       LD   C,#6D       RST  #10       RET; подпрограмма закраски прогрессбара; A-символ, B-количество символовPRDR       LD   C,A       XOR  A       OR   B       RET  Z       LD   A,C       LD   HL,MVPRBR1$       LD   (HL),A       INC  HL       DJNZ 1$       RET; подпрограмма подсчёта количества закрашиваемых знакомест; HL-количество блоков BLKRD/BLKWRPBCLC       XOR  A       OR   H       OR   L       RET  Z       LD   B,PBLEN       EX   DE,HL       LD   HL,#0000       LD   C,#001$       ADD  HL,DE       JR   NC,3$       INC  C3$       DJNZ 1$       LD   DE,(BLKSM)       XOR  A2$       INC  A       OR   A       SBC  HL,DE       JR   NC,2$       DEC  C       JP   P,2$       SRL  D       RR   E       OR   A       ADC  HL,DE       RET  P       DEC  A       RETPBLEN  EQU  23; процедура печати в главном окне строки "Из:"WRFRFL       LD   HL,MVFRPT       LD   (WRPTAD),HL       LD   HL,#0205       LD   (WRPTCR),HL       JR   WRFR03; печать в поле "в:"WRTOFL       LD   HL,MVTOPT       LD   (WRPTAD),HL       LD   HL,#0305       LD   (WRPTCR),HL;L5F53WRFR03       CALL FLPTST       RET  C       LD   DE,FNBUF       XOR  A       SBC  HL,DE       LD   A,L       CP   31       EX   DE,HL       JR   C,WRFR01       EXX       PUSH DE       EXX       POP  HL       LD   BC,30       XOR  A       SBC  HL,BC       PUSH HL       LD   B,3WRFR02       LD   (HL),"."       INC  HL       DJNZ WRFR02       POP  HLWRFR01       LD   BC,30       LD   DE,(WRPTAD)       PUSH DE       LDIR       LD   HL,(WRPTCR)       LD   C,#6B       RST  #10       POP  HL       LD   B,30       LD   C,#6D       RST  #10       RET; подпрограмма формирования в буфере FNBUF; пути и имени текущего открытого файлаFLPTST       LD   HL,FNBUF       LD   DE,69       XOR  A       LD   C,#47       RST  #10       RET  C       LD   C,#35       RST  #10       EXX       PUSH HL       EXX       LD   HL,FNBUF       LD   BC,69       LD   A,#20       CPIR       DEC  HL       EX   DE,HL       POP  HL       LD   C,#25       RST  #10       RET  C       LD   C,#4F       RST  #10       EXX       PUSH DE       EXX       POP  HL       LD   (HL),#20       RET; подпрограмма закраски области редактирования цветом; главного окнаLTSWCL       LD   A,(LTSWN+#04)       PUSH AF       LD   A,(MWINV+#04)       LD   (LTSWN+#04),A       LD   IX,LTSWN       LD   A,#FF       LD   C,#61       ; красим область редактирования       RST  #10       POP  AF       LD   (LTSWN+#04),A       LD   IX, MWINV       LD   C,#66       ; перевывод текста главного окна       RST  #10       RETWRPTAD DEFW #0000WRPTCR DEFW #0000; подпрограмма стирания окна адрес вектора которого в IX; закраски цветом стирания и перерисовывание главного окнаBLNKWN       LD   A,(IX+#04)       PUSH AF       LD   A,(CLCLR)       LD   (IX+#04),A       INC  A       LD   C,#61       RST  #10       POP  AF       LD   (IX+#04),A       LD   IX,MWINV       LD   A,#01       LD   C,#61       RST  #10       LD   C,#66       RST  #10       RET