       .GLOB RECD, WECD, RECD10, FDREAD, FDSTT, FDNXT       .GLOB FSTFLG, BUFSIZ, BUFBLK, L64FD, L634C       .GLOB FRDFLG, FSTBL1, FSTBLK, LSTBLK, MWINV       .GLOB WRFRFL, L5DC4, PGRD10, PGFRE, PGRDR       .GLOB BLUMFR, L64BC, L60BE, BLKRD, PRBR, PRSW; Открытие файла и чтение дескриптора перед чтениемPRRCF       CALL WECD       RET  C       CALL RECD10       LD   A,(HL)       LD   C,#26       RST  #10       RET  C       XOR  A       LD   HL,(LSTBLK)       OR   H       OR   L       JP   Z,PRSW09       EXX       PUSH HL       CALL FDREAD       POP  HL; Процедура чтения файлаRECD       PUSH HL       LD   HL,(FDNXT)       LD   DE,#0020       OR   A       SBC  HL,DE       LD   DE,(FDSTT)       XOR  A       SBC  HL,DE       JR   NZ,REC371       LD   A,#FFREC371       LD   (FSTFLG),A       LD   A,(BUFBLK)       LD   B,A       LD   A,(BUFSIZ)       SUB  B       LD   D,A       XOR  A       LD   E,A       LD   HL,(L64FD)       ADD  HL,DE       ; вычисляем адрес куда считывать       EX   DE,HL       POP  HL       PUSH HL       PUSH DE       CALL L634C       ; вычисляем размер в блоках текущего открытого файла       LD   DE,#0000       LD   A,(FRDFLG)       OR   A       JR   Z,REC370       LD   DE,(FSTBL1)       JR   RECD37REC370       LD   A,(FSTFLG)       OR   A       JR   Z,RECD37   ; если дескриптор первый, используем переменную FSTBLK       LD   DE,(FSTBLK)RECD37       OR   A       SBC  HL,DE       PUSH DE       LD   A,H       OR   A       JR   NZ,RECD35   ; переход, если остаток блоков больше 255       LD   A,(BUFBLK)       CP   L       JR   C,RECD35       LD   B,L         ; ветка, где остаток буфера больше остатка файла       SUB  B       LD   (BUFBLK),A  ; после расчёта количества считываемых блоков вычисляем остаток буфера       LD   HL,#0000       LD   (LSTBLK),HL ; обнуляем остаток блоков файла - файл влезает в буфер весь       JR   RECD36RECD35                  ; ветка, где остаток буфера меньше остатка файла       LD   HL,#0000       LD   A,(FRDFLG)       OR   A       JR   Z,REC351       LD   HL,(FSTBL1)       JR   RECD38REC351       LD   A,(FSTFLG)       OR   A       JR   Z,RECD38    ; если дескриптор первый, то уже заход не первый       LD   HL,(FSTBLK) ;RECD38       LD   A,(BUFBLK)       LD   B,A       LD   E,A       LD   D,#00       ADD  HL,DE       LD   (LSTBLK),HL       XOR  A       LD   (BUFBLK),A  ; обнуляем остаток буфераRECD36                  ; подходим к процедуре чтения       XOR  A           ; подсчитываем сумму прочитанных блоков       LD   D,A         ; для прогрессбара       LD   E,B       LD   HL,(BLKRD)       ADD  HL,DE       LD   (BLKRD),HL       POP  DE       POP  HL       LD   C,#2B       RST  #10       POP  HL           ; вспоминаем адрес дескриптора       RET  C       LD   IX,MWINV       LD   A,(FSTFLG)       LD   B,A       LD   A,(FRDFLG)       OR   B       CALL Z,WRFRFL       ; адрес дескриптора нужен для вывода имени копируемого файла       CALL PRBR       XOR  A       LD   (FRDFLG),A       LD   A,(BUFBLK)       OR   A                           ; Файл прочитали, возврат       JR   NZ,PRSW09       LD   A,(L5DC4)       DEC  A       JP   Z,PRRCF       ; Буфер забит, запись и продолжение чтения       CALL PRSW       JP   Z,PRRCF       ; забиты все страницы, забита память, пора писать       CALL BLUMFR      ; возвращает в HL количество свободных блоков в верхней памяти       LD   A,(BUFSIZ)       LD   E,A       LD   A,L       OR   A       SBC  HL,DE       ; сравниваем количество свободных блоков и размер буфера       JR   NC,PRSW07       LD   (BUFSIZ),A  ; если следующая партия не влезет, уменьшаем буферPRSW07       CALL PGRD10       LD   A,(HL)       OR   A       JR   NZ,PRSW08       LD   A,(L64BC)   ; если страниц больше не осталось - восстанавливаем размер буфера       LD   (BUFSIZ),APRSW08       LD   A,(BUFSIZ)       LD   (BUFBLK),A       LD   HL,(LSTBLK)       LD   (FSTBL1),HL       LD   A,#FF       LD   (FRDFLG),A       LD   C,#35       RST  #10       EXX       PUSH HL       EXX       LD   HL,(LSTBLK)       XOR  A       OR   H       OR   L       POP  HL       JP   NZ,RECDPRSW09       LD   A,(L60BE)       AND  #01       RET  Z       LD   C,#3C       RST  #10       RET  C       LD   C,#02       RST  #10       RET