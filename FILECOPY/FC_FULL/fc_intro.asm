       .GLOB L6575, LTSWN, L687F, CPDFLG       .GLOB L5DC5, FDSTT, FDNXT, FDEND, L64FD, L635E, L636E, L6023, L62FD, L6020, L5F53       .GLOB L62FC, L6036, L60BE, MWTXT, MVTTLP, MVTXTW, L60DD, SREDA, RECD10, CRLVL, L634C, BLKSM       .GLOB L6161, L6094, L639E, L6555, L64BC, L5DC4, L5FA1, L6045, L5DC3, L653D       .GLOB MVMNBT, MVTX2W, LTSWCL, L6015, MVBIND, L5FAC, L5DD8       .GLOB L5EC4, L5ED2, L5E9E, L5EB1, L5EA6, L5EB9, L5F4F, L5EE5, L5EF4       .GLOB L5E53, L5DC7, L5DCB, L5DCD, L5DE9, L5DC9, L5DCC, L5DCE, L64EE, L5E7D, L5E94       .GLOB MRKFLS, SPSNDL6575       CALL L67F7        ; разбросать цвета из UnCo по векторам окон       LD   A,(L5DC5)     ; макс. файлов за один заход       LD   HL,0       LD   DE,#0020       LD   B,AL6582  ADD  HL,DE       DJNZ L6582       EX   DE,HL       LD   HL,L6575       LD   (FDSTT),HL       LD   (FDNXT),HL       ADD  HL,DE       LD   (L64FD),HL   ; HL=#6975       LD   (FDEND),HL       LD   (SPSND),SP   ; сохраняем SP       CALL L67A6        ; обработка параметров командной строки       RET  C       LD   C,#87       RST  #10       LD   (MRKFLS),A    ; A-число отмеченных файлов       EXX       LD   A,H       LD   (L636E),A    ; H-максимальный номер отмеченного файла       DEC  BC       LD   A,(BC)       ; номер панели 0-левая, 1-правая       INC  BC       OR   A       JR   NZ,L65A3       INC  BCL65A3  LD   A,(BC)       ; (BC)-номер канала соответствующей панели       LD   C,#16       RST  #10          ; по номеру канала получаем данные канала       RET  C       EXX       LD   (L6023),HL   ; HL-адрес тела канала       LD   A,(HL)       LD   (L62FD),A    ; номер канала       INC  HL       LD   DE,L6020       LDI       LDI       LD   A,(HL)       LD   C,#16       RST  #10       RET  C       EXX       LD   DE,L5F53       LD   BC,#0037       LDIR             ; копируем текущий путь       LD   C,#33       RST  #10       EXX       LD   (L62FC),A       LD   (L6036),HL  ; номер 0-го блока текущего каталога       LD   A,(L60BE)       RRCA       JR   NC,COPCNT    ; смотрим - это copy или move       LD   HL,MWTXT+47       LD   (MWTXDS),HL                         ; Меняем заголовок окна       LD   HL,MOVTTL       LD   BC,MOVTLN       LD   DE,MVTTLP       LDIR                         ; Меняем надпись в окне       LD   HL,MOVTXT       LD   BC,MVTXLN       LD   DE,MVTXTW       LDIR                         ; Добиваем пробелами надпись       LD   H,D       LD   L,E       DEC  HL       LD   BC,#0004       LDIRCOPCNT       LD   A,(MRKFLS)       OR   A           ; A-число отмеченных файлов в тек. панели       JP   NZ,FLMRKD   ; файлы отмечены-переходим       LD   C,#8A       RST  #10       LD   (L60DD),A   ; получаем номер единственного файла       LD   DE,(L60DD)       LD   C,#27       RST  #10         ; HL'-дескриптор того файла       RET  C       EXX       PUSH HL       LD   BC,#000B       ADD  HL,BC       BIT  5,(HL); если каталог, выходим;       RET  NZ       POP  HL       JP   Z,COPC01       XOR  A       LD   (CPDFLG),A       LD   IX,SREDA       LD   C,#36       RST  #10                          ; каталог не пуст, требуется проверка на флаг и рекурсивное удаление       LD   A,(L60DD)       LD   C,#26       RST  #10       RET  C       EXXCRECD11       PUSH HL       DEC  HL       LD   A,(HL)       ; получаем номер текущего каталога в каталоге уровнем выше       CALL RECD10       LD   (HL),A       ; запоминаем номер в мвссиве       POP  HL       LD   BC,#0013     ; номер 0-го ,лока каталога по смещению 19       ADD  HL,BC       LD   E,(HL)       INC  HL       LD   D,(HL)       LD   C,#21       RST  #10       RET  C       LD   HL,CRLVL       INC  (HL)       CALL RECD10DRECD1       LD   A,(HL)       LD   C,#26       RST  #10       JP   NC,CRECD3       CP   #50          ; проверяем на ошибку 80 (выход за список каталога)       SCF       RET  NZ; ветка возвращения на уровень выше и удаления каталога из которого вышли       XOR  A            ; перебрали все файлы в каталоге, возвращаемся на уровень выше       LD   C,#26       RST  #10       RET  C       EXX       LD   BC,#000C       ADD  HL,BC       LD   E,(HL)       INC  HL       LD   D,(HL)       LD   C,#21       RST  #10       RET  C       CALL RECD10       LD   (HL),#00       LD   HL,CRLVL       DEC  (HL)       JR   Z,CRECD4     ; вернулись на 0-й уровень       JP   CRECD2       ; возвращаемся на уровень выше, переходим к следующему файлуCRECD3       OR   A       JP   Z,CRECD2     ; открыли файл с номером 0, это текущий каталог; здесь открыт файл и с ним можно проводить действия; HL'-адрес системного дескриптора открытого файла       EXX       PUSH HL       LD   BC,#000B       ADD  HL,BC       LD   A,(HL)       POP  HL       BIT  0,A         ; файл не удалён?       JP   Z,CRECD2     ; файл/каталог удалён, пропускаем       BIT  5,A         ; проверяем-открытый файл каталог?       JP   NZ,CRECD11DRECD33       CALL L634C       LD   DE,(BLKSM)       ADD  HL,DE       LD   (BLKSM),HLCRECD2       CALL RECD10       INC  (HL)       JR   DRECD1CRECD4       LD   IX,SREDA       XOR  A       LD   C,#37       RST  #10       LD   HL,#0000       LD   (CRLVL),HL       LD   DE,(L60DD)       LD   C,#27       RST  #10       RET  C       EXX       PUSH HL       JR   COPC02COPC01       PUSH HL       CALL L634C       ; подсчёт блоков при копировании       LD   (BLKSM),HL  ; единственного файла       LD   A,#01       LD   (CPDFLG),A  ;COPC02       EXX       CALL L635E       ; получаем в HL маску отметки текущего файла       DEC  HL          ; переходим на номер отметки       SET  0,(HL)       LD   A,#1       LD   (MRKFLS),A   ; число отмеченных файлов                        ; вывод написи "filename.ext" в       LD   HL,(MWTXDS)       LD   (HL),#22    ; кавычку открываем       INC  HL       POP  DE       EX   DE,HL       LD   C,#4F       RST  #10       EXX       EX   DE,HL       LD   (HL),#22    ; кавычку закрываем       INC  HL       LD   (HL),#20       INC  HL       LD   (HL),"в"       EXX       JR   L65F8                        ; вывод надписи в главное окно "xxx файл(а,ов) в"FLMRKD       LD   DE,(MRKFLS)       LD   HL,(MWTXDS)       PUSH HL       XOR  A       LD   A,3       LD   BC,#0A7C       RST  #10       POP  HL       LD   BC,#0004       ADD  HL,BC       EX   DE,HL       LD   HL,MLSTXT       LD   BC,MLSTLN       LDIR       LD   A,(L636E)    ; количество файлов в каталоге       LD   B,AFLMR01       LD   E,B       LD   C,#86       RST  #10       EXX       DEC  HL       LD   A,(HL)       EXX       OR   A       JR   Z,FLMR02       LD   C,#27       RST  #10       RET  C       EXX       CALL L634C       LD   DE,(BLKSM)       ADD  HL,DE       LD   (BLKSM),HLFLMR02       DJNZ FLMR01       LD   A,#02       LD   (CPDFLG),AL65F8       LD   A,#1       LD   (L6161),A       LD   (L6094),A       LD   (L639E),A; Подготовка и вывод главного окна;       LD   IX,MWINV;       LD   A,#01;       LD   C,#61       ; выводим главное окно;       RST  #10;       LD   C,#66       ; текст главного окна;       RST  #10;       LD   IX,LTSWN;       LD   A,#FF;       LD   C,#61       ; красим область редактирования;       RST  #10;       LD   IX,L66B0;       LD   C,#61;       XOR  A;       RST  #10         ; рисуем большое фоновое окно;       LD   IX,L67E7;       LD   DE,L5DE5;       LD   HL,L67F3;       LD   A,(L60BE);       RRCA;       JR   NC,L661F    ; смотрим - это copy или move;       LD   HL,L67EF;       INC  DE;L661F  LD   A,(DE);       LD   (IX+#4),A;       XOR  A;       RST  #10         ; рисуем маленькое окно сверху;       LD   C,#67;       RST  #10         ; выводим соответствующую надпись copy/move; Уменьшение дискового кэша       CALL L6555       ; уменьшаем кэш до #0C блоков       LD   C,#10       RST  #10         ; получаем в HL адрес вектора конфигурации ядра       EXX       PUSH HL       POP  IX       LD   L,(IX+#5)       LD   H,(IX+#6)   ; HL - адрес начала электронного диска       LD   DE,(L64FD)  ; адрес начала буфера для копирования       OR   A       SBC  HL,DE       ; вычисляем количество свободной памяти (буфер для копирования)L663F  LD   A,#23       RET  C       LD   A,H         ; A-количество блоков       LD   (L64BC),A       AND  A       SCF       JR   Z,L663F       CALL L6825       ; Проверка расширенной памяти       JR   Z,L6654     ; NZ - нет расширенной памяти       LD   A,#1       LD   (L5DC4),AL6654;       LD   IX,L66CC       CALL L6770        ; процедура подготовки текста меню настроек;       LD   HL,L66D9;       LD   HL,MNUTXT;       LD   C,#67;       RST  #10L6665  CALL L5FA1        ; подпрограмма запроса пути куда копировать       RET  C       JR   Z,L6679      ; переход, если выход по Enter       CP   #10       JP   Z,L6045      ; нажат SS/A - выходим;       LD   IX,L66CC;       LD   IX,MNUWIN       LD   IX,MNUWIN       LD   A,#01       LD   C,#61       RST  #10       LD   C,#91       RST  #10          ; нажат SS/SP - работаем с меню       LD   A,(IX+#04)       PUSH AF       XOR  A       LD   (IX+#04),A       INC  A       LD   C,#61       RST  #10       POP  AF       LD   (IX+#04),A       JR   L6665L6679  CALL L6899        ; проверяем копирование на тот же диск       LD   A,(L5DC3)       AND  #8       CALL NZ,L653D     ; диски разные - открываем устройство и каталог назначения       RET  C       JR   NZ,L6665;       LD   A,(L66B4);       LD   (L66D0),A;       LD   A,#1;       LD   C,#61;       LD   IX,L66CC;       RST  #10          ; стираем окно с меню;       LD   DE,0         ; число отмеченных файлов;L6697  EQU  $-#2;       XOR  A;       LD   A,#3;       LD   HL,L5EBD;       LD   BC,LA7C      ; преобразуем количество отмеченных файлов в ascii;       RST  #10;       LD   IX,L5EB5;       CALL L5FF5        ; вывод окошка справа с количеством файлов;       CALL L5FF1        ; вывод окна с надписью SOURCE; здесь желательно сделать очистку главного окна; и подсчёт общего количества копируемых блоков       LD   DE,MVMNBT       LD   H,D       LD   L,E       DEC  HL       LD   BC,#0008       LDIR       LD   HL,FRMTXT       LD   DE,MVTXTW       LD   BC,FRTXLN       LDIR       LD   H,D       LD   L,E       INC  DE       LD   BC,30       LD   (HL),#20       LDIR       LD   HL,TOTXT       LD   DE,MVTX2W       LD   BC,TOTXLN       LDIR       LD   H,D       LD   L,E       INC  DE       LD   BC,31       LD   (HL),#20       LDIR       CALL LTSWCL       JP   L6015L66B0       DEFB #00       DEFB #08       DEFB #10       DEFB #20L66B4       DEFB #00       DEFB #FFL66B6       DEFW L6761       DEFW L6757       DEFW L6753       DEFW L673B       DEFW L6765L66C0  DEFB #04           ; цвет курсора при отра,отке Enter       DEFB #00           ; управляющий регистр менюL66C2  DEFB #39           ; цвет курсора       DEFB #01           ; позиция курсора       DEFW L6770         ; адрес инициализации символьного массива       DEFW #0000         ; адрес программы пользователя       DEFW #0000         ; адрес списка горячих клавиш       DEFW L66B6         ; адрес списка функций отработки по клавише Enter                          ; вектор окна с менюL66CC       DEFB #09       DEFB #09       DEFB #07       DEFB #0EL66D0  DEFB #00       DEFB #FF       DEFB #0D       DEFB #11L66D4  DEFB #01       DEFB #01       DEFB #01       DEFB #01       DEFB #01L66D9  DEFM "CHANGE DISK    "L66E8  DEFB #00       DEFB #0D       DEFM "OVERWRITE      "L66F9  DEFB #00L66FA  DEFB #0D       DEFM "ASK OVERWRITE  "L6706  EQU  $-#4L670A  DEFB #00       DEFB #0D       DEFM "BUFFER    +16 kB"L6716  EQU  $-#6L6718  EQU  $-#4       DEFB #0D       DEFM "CHANGE PATH"L6725  EQU  $-#3       DEFB #03L6729  DEFM "   OFF+16 kB+80 kB"L672A  EQU  L6729+#1L672F  EQU  L6729+#6L6734  EQU  L6729+#0BL6735  EQU  L6729+#0CL6736  EQU  L6729+#0DMNUPRC       DEFW #0000       DEFW L6761       DEFW L6757       DEFW L6753       DEFW L673B       DEFW L6765       DEFW #0000MNUVEC DEFB #04           ; цвет курсора при отра,отке Enter       DEFB #00           ; управляющий регистр меню       DEFB %00000100     ; цвет курсора       DEFB #02           ; позиция курсора       DEFW L6770         ; адрес инициализации символьного массива       DEFW #0000         ; адрес программы пользователя       DEFW #0000         ; адрес списка горячих клавиш       DEFW MNUPRC        ; адрес списка функций отработки по клавише EnterMNUWIN       DEFB 7       DEFB 11       DEFB 9       DEFB 18       DEFB %00100000       DEFB %00000001       DEFB 11       DEFB 21       DEFB #00       DEFB #01       DEFB #01       DEFB #01       DEFB #01       DEFB #01       DEFB #00MNUTXT       DEFM "╔══════ Опции ══════╗"       DEFM "║ Cмена диска   [ ] ║"       DEFM "║ Перезапись    [ ] ║"       DEFM "║ Запрос прз.   [ ] ║"       DEFM "║ Буфер       [   ] ║"       DEFM "║ [Возврат]         ║"       DEFM "╚═══════════════════╝"       DEFB #03BUFNOR DEFM "Норм"BUF16K DEFM "+16k"BUF80K DEFM "+80k"CHDSAS EQU  MNUTXT + 38OVRWRA EQU  MNUTXT + 59OVWRAA EQU  MNUTXT + 80BUFMAA EQU  MNUTXT + 99MOVTTL DEFM "══ Перенос ══"MOVTLN EQU  $ - MOVTTLMOVTXT EQU  MOVTTL + 3MVTXLN EQU  8MLSTXT DEFM "файл(а,ов) в"MLSTLN EQU  $ - MLSTXTMWTXDS DEFW MWTXT + 51FRMTXT DEFM "из:"FRTXLN EQU  $ - FRMTXTTOTXT  DEFM "в:"TOTXLN EQU  $ - TOTXTLTSWN       DEFB 3       DEFB 9       DEFB 2       DEFB 26       DEFB %00101000       DEFB #FF       DEFB 5       DEFB 33; флаг копирования директорииCPDFLG DEFB #00         ; 0-каталог, 1-файл, 2-отмеченные файлыL673B  LD   HL,L5DC4       LD   A,(HL)       CP   #5       LD   A,#B       JR   Z,L674B       LD   A,#5       JR   C,L674B       LD   A,#1L674B  LD   (HL),A       CALL L6825L674F  JR   Z,L675E       JR   L673BL6753  LD   A,#2       JR   L6759L6757  LD   A,#1L6759  LD   HL,L5DC3       XOR  (HL)       LD   (HL),AL675E  XOR  A       INC  A       RETL6761       LD   A,#8       JR   L6759L6765       OR   #FF       RET; 0-й бит в B=1 - A="Y", B=0 - A="N"L6768  RRC  B       LD   A,#20       RET  NC       LD   A,#FB       RET; подпрограмма меню инициализации символьного массиваL6770  LD   A,(L5DC3)       LD   B,A       ; в B помещаем байт конфигурации       CALL L6768;       LD   (L66F9),A       LD   (OVRWRA),A       CALL L6768;       LD   (L670A),A       LD   (OVWRAA),A       RRC  B       CALL L6768       XOR  #DB        ; меняем галку на пробел, или обратно;       XOR  #17       ; меняем Y на N, или N на Y;       LD   (L66E8),A ; помещаем результат в CHANGE DISK       LD   (CHDSAS),A       LD   A,(L5DC4);       LD   DE,L6716       LD   DE,BUFMAA       CP   #5;       LD   HL,L6729       LD   HL,BUFNOR       JR   C,L679F;       LD   HL,L672F       LD   HL,BUF16K       JR   Z,L679F;       LD   HL,L6735       LD   HL,BUF80KL679F;       LD   BC,L6       LD   BC,#0003       PUSH HL       LDIR           ; копируем строку +16 kb/+80 kb       LD   HL,BUFNOR       XOR  A       XOR  H       XOR  L       POP  HL       XOR  H       XOR  L       JR   NZ,BFINMW       LD   HL,MVBIND - 1 ; если в HL адрес BUFNOR, то заменяем его на MVBIND-1, там будет "═"                          ; копируем его 4 разаBFINMW       LD   DE,MVBIND       LD   BC,#0004       LDIR           ; индикация буфера на главном окне       XOR  A       RETL67A6  LD   C,#41       RST  #10       RET  C       LD   C,#43        ; получаем в A ключ командной строки (/c,/m, т.д.)       RST  #10       RET  C       LD   C,#41       JP   NZ,#0010     ; ключа нет после восстановления возврат       OR   A       JR   Z,L67A6      ; обнаружен путь\файл       RES  5,A          ; анализируем ключи       CP   #41          ; /a/A       JR   Z,L67D3       CP   #42          ; /b/B       JR   Z,L67D8       LD   HL,L67D0       LD   BC,#0301L67C6  CP   (HL)       JR   Z,L67DF       SLA  C       INC  HL       DJNZ L67C6       JR   L67A6L67D0       DEFM "MCS"        ; возможные ключиL67D3  LD   (L5FAC),A       JR   L67A6L67D8  LD   A,#1       LD   (L5DC4),A       JR   L67A6L67DF  LD   HL,L60BE       LD   A,C       OR   (HL)       LD   (HL),A       ; с ключом /c получаем #00 OR #02       JR   L67A6L67E7  DEFB #0D       DEFB #06       DEFB #03       DEFB #06       DEFB #00       DEFB #FF       DEFB #13       DEFB #04L67EF       DEFM "MOVE"L67F3       DEFM "COPY"L67F7       LD   DE,L5DD8    ; цвета в маркере UnCo       LD   HL,L680B    ; таблица адресов, куда надо разместить цвета       LD   B,#D        ; адресов 13L67FF  LD   A,(DE)       INC  DE       PUSH DE       LD   E,(HL)       INC  HL       LD   D,(HL)       INC  HL       LD   (DE),A       POP  DE       DJNZ L67FF       RETL680B       DEFW L5EC4       DEFW L5ED2       DEFW L66B4       DEFW L66D0       DEFW L66C2       DEFW L66C0       DEFW L5E9E       DEFW L5EB1       DEFW L5EA6       DEFW L5EB9       DEFW L5F4F       DEFW L5EE5       DEFW L5EF4; подпрограмма проверки работы с расширенной памятьюL6825       LD   A,(L5DC4)       DEC  A       RET  Z       CP   #4       LD   DE,L5E53       LD   BC,(L5DC7)       LD   A,(L5DCB)       LD   HL,(L5DCD)       LD   H,#0       JR   Z,L684C       LD   DE,L5DE9       LD   BC,(L5DC9)       LD   A,(L5DCC)       LD   HL,(L5DCE)       LD   H,#C0L684C  LD   (L64EE),DE       LD   (L5E7D),BC       LD   (L5E94),A       LD   D,A       LD   E,(HL)       DI       LD   A,(HL)       DEC  (HL)       DEC  A       XOR  (HL)       LD   (HL),E       JR   NZ,L6868       LD   A,H       OR   A       JR   NZ,L6868       INC  A       EI       RETL6868  OUT  (C),L       LD   A,(HL)       DEC  (HL)       DEC  A       XOR  (HL)       OUT  (C),D       EI       RET  NZ       LD   A,(HL)       CP   E       LD   (HL),E       RET  NZ       DI       OUT  (C),L       INC  (HL)       OUT  (C),D       EI       XOR  A       RETL687F  LD   A,(L5DC4)       DEC  A       RET  Z       LD   HL,(L64EE)       LD   E,(HL)       INC  HL       LD   D,(HL)       EX   DE,HL       LD   B,A       LD   A,(L64BC)L688F  CP   (HL)       JR   NC,L6893       LD   (HL),AL6893  INC  HL       INC  HL       INC  HL       DJNZ L688F       RETL6899  LD   HL,L5F53     ; буфер путиL689C  LD   A,(HL)       CP   #3A          ; проверяем первй символ на ":"       JR   Z,L68A7      ; нашли в пути : после имени диска       CP   #D       INC  HL       JR   NZ,L689C       RETL68A7  DEC  HL       LD   A,(HL)       LD   C,#4A       RST  #10          ; преобразуем имя диска в номер диска       RET  NZ       LD   (L62FD),A       LD   HL,L62FC       CP   (HL)         ; проверяем копирование на один и тот же диск       RET  Z       LD   HL,L5DC3       SET  3,(HL)       ; диск не один и тот же - устанавливаем бит запроса смены диска       RETLC066  EQU  #C066LD25E  EQU  #D25E