       ORG  #5DC0       .GLOB L6575, LTSWN, L687F, CPDFLG       .GLOB L5DC5, FDSTT, FDNXT, FDEND, L64FD, L635E, L636E, L6023, L62FD, L6020, L5F53       .GLOB L62FC, L6036, L60BE, MWTXT, MVTTLP, MVTXTW, L60DD, SREDA, RECD10, CRLVL, L634C, BLKSM       .GLOB L6161, L6094, L639E, L6555, L64BC, L5DC4, L5FA1, L6045, L5DC3, L653D       .GLOB MVMNBT, MVTX2W, LTSWCL, L6015, MVBIND, L5FAC, L5DD8       .GLOB L5EC4, L5ED2, L5E9E, L5EB1, L5EA6, L5EB9, L5F4F, L5EE5, L5EF4       .GLOB L5E53, L5DC7, L5DCB, L5DCD, L5DE9, L5DC9, L5DCC, L5DCE, L64EE, L5E7D, L5E94L6     EQU  #6L8	EQU	#8LB	EQU	#BLC	EQU	#CLF	EQU	#FL10	EQU	#10L14	EQU	#14L20	EQU	#20L37	EQU	#37L100	EQU	#100L101	EQU	#101L202	EQU	#202L26E	EQU	#26EL301	EQU	#301L505	EQU	#505LA7C	EQU	#A7CLB00	EQU	#B00L2036	EQU	#2036L3A5E	EQU	#3A5EL3D5D	EQU	#3D5DL4000	EQU	#4000	JP   L6575L5DC3	DEFB	#03L5DC4  DEFB #0B         ; использование буфера для копированияL5DC5  DEFB #20         ; максимальное количество файлов за 1 заходL5DC6	DEFB	#0CL5DC7	DEFB	#3E	DEFB	#FFL5DC9  DEFW #7FFDL5DCB  DEFB #C0L5DCC	DEFB	#10L5DCD	DEFB	#C7; Страницы памяти буфера 80кбL5DCE  DEFB #11L5DCF  DEFB #13L5DD0  DEFB #14L5DD1  DEFB #16L5DD2  DEFB #17       DEFM "UnCo"       DEFB #11L5DD8	DEFB	#05	DEFB	#20L5DDA	DEFB	#03	DEFB	#04	DEFB	#28	DEFB	#A0	DEFB	#05	DEFB	#20	DEFB	#05	DEFB	#20	DEFB	#05	DEFB	#90	DEFB	#90L5DE5	DEFB	#04	DEFB	#03L5DE7	DEFB	#06	DEFB	#28L5DE9       DEFW L5DFF       DEFW L5E02       DEFW L5E05       DEFW L5E08       DEFW L5E0B       DEFW L5E0E       DEFW L5E11       DEFW L5E14       DEFW L5E17       DEFW L5E1A       DEFW L5DFFL5DFF       DEFB #20       DEFW L5E1DL5E02	DEFB	#20       DEFW L5E22L5E05	DEFB	#20       DEFW L5E27L5E08	DEFB	#20       DEFW L5E2CL5E0B	DEFB	#20       DEFW L5E31L5E0E	DEFB	#20       DEFW L5E36L5E11       DEFB #20       DEFW L5E3BL5E14	DEFB	#20       DEFW L5E40L5E17	DEFB	#20       DEFW L5E45L5E1A	DEFB	#20       DEFW L5E4CL5E1D       LD   A,(L5DCE)       JR   L5E48L5E22       LD   A,(L5DCE)       JR   L5E4FL5E27       LD   A,(L5DCF)       JR   L5E48L5E2C       LD   A,(L5DCF)       JR   L5E4FL5E31       LD   A,(L5DD0)       JR   L5E48L5E36       LD   A,(L5DD0)       JR   L5E4FL5E3B       LD   A,(L5DD1)       JR   L5E48L5E40       LD   A,(L5DD1)       JR   L5E4FL5E45       LD   A,(L5DD2)L5E48       LD   D,#C0       JR   L5E7AL5E4C       LD   A,(L5DD2)L5E4F       LD   D,#E0       JR   L5E7AL5E53       DEFW L5E5D       DEFW L5E60       DEFW L5E63       DEFW L5E66       DEFW L5E5DL5E5D       DEFB #10       DEFW L5E69L5E60	DEFB	#10       DEFW L5E6DL5E63	DEFB	#10       DEFW L5E71L5E66	DEFB	#10       DEFW L5E75L5E69       LD   D,#00       JR   L5E77L5E6D       LD   D,#10       JR   L5E77L5E71       LD   D,#20       JR   L5E77L5E75       LD   D,#30L5E77       LD   A,(L5DCD)L5E7A       DI       EXX       LD   BC,#0000L5E7D  EQU $-2       OUT  (C),A       EXX       LD   C,#00       LD   E,C       LD   HL,(L64FD)L5E88       LD   A,(DE)       LDI       DEC  HL       LD   (HL),A       INC  HL       LD   A,B       OR   C       JR   NZ,L5E88       EXX       LD   A,#00L5E94  EQU $-1       OUT  (C),A       EI       XOR  A       RETL5E9A  DEFB #01	DEFB	#0A	DEFB	#03	DEFB	#0EL5E9E  DEFB #00	DEFB	#FF	DEFB	#03	DEFB	#28L5EA2	DEFB	#02	DEFB	#0D	DEFB	#03	DEFB	#05L5EA6  DEFB #00	DEFB	#FF	DEFB	#04	DEFB	#03L5EAA	DEFB	#20	DEFB	#20	DEFB	#20L5EAD	DEFB	#11	DEFB	#0A	DEFB	#03	DEFB	#0EL5EB1  DEFB #00	DEFB	#FF	DEFB	#18	DEFB	#28L5EB5	DEFB	#19	DEFB	#0D	DEFB	#03	DEFB	#05L5EB9  DEFB #00	DEFB	#FF	DEFB	#23	DEFB	#03L5EBD	DEFB	#20	DEFB	#20	DEFB	#20L5EC0  DEFB #09	DEFB	#0D	DEFB	#03	DEFB	#0EL5EC4  DEFB #00	DEFB	#FF	DEFB	#12	DEFB	#06       DEFM "SOURCE"L5ECE  DEFB #09	DEFB	#0D	DEFB	#03	DEFB	#0EL5ED2  DEFB #00	DEFB	#FF	DEFB	#10	DEFB	#0B       DEFM "DESTINATION"L5EE1  DEFB #07	DEFB	#14	DEFB	#03       DEFB #13L5EE5  DEFB #00	DEFB	#FF       DEFB #0B       DEFB #16;       DEFM "No path"       DEFM "Целевой путь не найден"       DEFB #03L5EF0  DEFB #0A	DEFB	#14	DEFB	#03       DEFB #0DL5EF4  DEFB #38	DEFB	#FF       DEFB #0F       DEFB #0E;       DEFM "Not iS-DOS disk !"       DEFM "Не iS-DOS диск"       DEFB #03L5F09  DEFB #04	DEFB	#12	DEFB	#05	DEFB	#18	DEFB	#00	DEFB	#FF	DEFB	#08	DEFB	#1B       DEFM "FILE   "L5F18  DEFB #00	DEFB	#00	DEFB	#00	DEFB	#00	DEFB	#00	DEFB	#00	DEFB	#00	DEFB	#00	DEFB	#00	DEFB	#00	DEFB	#00	DEFB	#00       DEFM "  EXISTS"       DEFB #0D	DEFB	#0D       DEFM "   Over    Skip    Quit"       DEFB #03L5F46	DEFB	#07	DEFB	#14	DEFB	#03	DEFB	#06	DEFB	#07DESTWN       DEFB 9       DEFB 11       DEFB 7       DEFB 15       DEFB %00100000       DEFB %00000001       DEFB 13       DEFB 18       DEFM "╔═ В дисковод   ═╗"       DEFM "║ вставьте диск  ║"       DEFM "║                ║"       DEFM "║ [Enter] [SS/A] ║"       DEFM "╚════════════════╝"       DEFB #03DSTTXT       DEFM " ПРИёМНИК "SRCTXT       DEFM " ИСТОЧНИК "DSTXLN EQU  $ - SRCTXTDSKLET DEFM "  :"OWINV        DEFB 5        DEFB 12        DEFB 11        DEFB 22        DEFB %00110000        DEFB %00000001        DEFB 8        DEFB 27OVTXT        DEFM "╔════ Файл существует ════╗"        DEFM "║                         ║"        DEFM "║                         ║"        DEFM "║                         ║"        DEFM "╟─────────────────────────╢"        DEFM "║ [√] Примен. ко всем [A] ║"        DEFM "╟─────────────────────────╢"        DEFM "║ [Замена] [Проп] [Выход] ║"        DEFM "╚═════════════════════════╝"        DEFB #03OVFLGW  EQU  OVTXT + 138LTEFWN        DEFB 7        DEFB 14        DEFB 3        DEFB 18        DEFB %00001111        DEFB #FF        DEFB 10        DEFB 23OVFLG        DEFB #01OVPOS        DEFB #01OVPO01        DEFB 7        DEFB 20        DEFB 1        DEFB 7        DEFB %00101000        DEFB #FF        DEFB 10        DEFB 8OVPBTL        DEFW #1306        DEFW #0E05        DEFW #0707OVPBED; вектор окна со строкой куда копироватьL5F4B  DEFB #02	DEFB	#10	DEFB	#04	DEFB	#1CL5F4F  DEFB #00	DEFB	#FF	DEFB	#04	DEFB	#21L5F53                    ; путь куда копировать       DEFS 55	DEFB	#20	DEFB	#20	DEFB	#20	DEFB	#20	DEFB	#20	DEFB	#20	DEFB	#20	DEFB	#20	DEFB	#20	DEFB	#20	DEFB	#20	DEFB	#0DFNBUF       DEFS 69MWINV       DEFB 1       DEFB 6       DEFB 9       DEFB 30       DEFB %00111000       DEFB %00000001       DEFB 3       DEFB 37MWTXT       DEFM "╔═══════════ Копирование ═══════════╗"       DEFM "║ Копирование                       ║"       DEFM "║                                   ║"       DEFM "║                                   ║"       DEFM "╟───────────────────────────────────╢"       DEFM "║      [Enter] [SS/SP] [SS/A]       ║"       DEFM "╚═══════════════════════════════════╝"       DEFB #03MVTTLP EQU  MWTXT + 12MVTXTW EQU  MWTXT + 39MVTX2W EQU  MWTXT + 76MVBIND EQU  MWTXT + 30MVMNBT EQU  MWTXT + 200MVFRPT EQU  MWTXT + 42MVTOPT EQU  MWTXT + 79; подпрограма вывода окна с вектором в IX и установки координат печати в левый верхний уголL5F96  XOR  A	LD   C,#61	RST  #10	LD   HL,L100	LD   C,#6B	RST  #10       RETL5FA1;       LD   IX,L5F4B;       CALL L5F96       LD   IX,MWINV       LD   A,#01       LD   C,#61       ; выводим главное окно       RST  #10       LD   C,#66       ; текст главного окна       RST  #10       LD   IX,LTSWN       LD   A,#FF       LD   C,#61       ; красим область редактирования       RST  #10       LD   HL,#0000       LD   C,#6B       RST  #10       LD   HL,L5F53       LD   A,#0       ; если здесь не 0 - редактор не выводитсяL5FAC	EQU	$-#1	OR   A	JR   NZ,L5FBF	LD   A,#21	LD   DE,LB00	LD   BC,L26E	RST  #10	PUSH AF	CALL L5FC4	POP  AF       RETL5FBF	LD   C,#67	RST  #10	XOR  A       RETL5FC4	LD   A,#0L5FC5	EQU	$-#1	AND  A	RET  Z	LD   IX,L5F09	LD   A,(L5DDA)	LD   (IX+#4),A	XOR  A	LD   (L5FC5),A	INC  A	LD   C,#61	RST  #10       RET;       LD   IX,L5F4B;       JR   L5FF5L5FE0	LD   IX,L5EF0	JR   L5FEAL5FE6	LD   IX,L5EE1L5FEA	LD   A,#55	LD   (L5FC5),A	JR   L5FF5L5FF1	LD   IX,L5EC0L5FF5	XOR  A	LD   C,#61	RST  #10	LD   C,#66	RST  #10       RETL5FFD	CALL L5F96	EX   DE,HL	LD   B,#8	CALL L600C	LD   BC,L8	ADD  HL,BC	LD   B,#3L600C	LD   C,#6D	RST  #10	LD   A,#20	LD   C,#A	RST  #10       RET; процедура печати в главном окне строки "Из:"WRFRFL       LD   HL,MVFRPT       LD   (WRPTAD),HL       LD   HL,#0205       LD   (WRPTCR),HL       JR   WRFR03WRTOFL       LD   HL,MVTOPT       LD   (WRPTAD),HL       LD   HL,#0305       LD   (WRPTCR),HL;L5F53WRFR03       CALL FLPTST       RET  C       LD   DE,FNBUF       XOR  A       SBC  HL,DE       LD   A,L       CP   31       EX   DE,HL       JR   C,WRFR01       EXX       PUSH DE       EXX       POP  HL       LD   BC,30       XOR  A       SBC  HL,BC       PUSH HL       LD   B,3WRFR02       LD   (HL),"."       INC  HL       DJNZ WRFR02       POP  HLWRFR01       LD   BC,30       LD   DE,(WRPTAD)       PUSH DE       LDIR       LD   HL,(WRPTCR)       LD   C,#6B       RST  #10       POP  HL       LD   B,30       LD   C,#6D       RST  #10       RETFLPTST       LD   HL,FNBUF       LD   DE,69       XOR  A       LD   C,#47       RST  #10       RET  C       LD   C,#35       RST  #10       EXX       PUSH HL       EXX       LD   HL,FNBUF       LD   BC,69       LD   A,#20       CPIR       DEC  HL       EX   DE,HL       POP  HL       LD   C,#25       RST  #10       RET  C       LD   C,#4F       RST  #10       EXX       PUSH DE       EXX       POP  HL       LD   (HL),#20       RETLTSWCL       LD   A,(LTSWN+#04)       PUSH AF       LD   A,(MWINV+#04)       LD   (LTSWN+#04),A       LD   IX,LTSWN       LD   A,#FF       LD   C,#61       ; красим область редактирования       RST  #10       POP  AF       LD   (LTSWN+#04),A       LD   IX, MWINV       LD   C,#66       ; перевывод текста главного окна       RST  #10       RETWRPTAD DEFW #0000WRPTCR DEFW #0000BLNKWN       LD   A,(IX+#04)       PUSH AF       XOR  A       LD   (IX+#04),A       INC  A       LD   C,#61       RST  #10       POP  AF       LD   (IX+#04),A       LD   IX,MWINV       LD   A,#01       LD   C,#61       RST  #10       LD   C,#66       RST  #10       RET; подпрограмма, выводящая окна "вставьте диск"; A=0 диск ИСТОЧНИК, A<>0 диск ПРИёМНИКDSTWIN       PUSH AF       OR   A       LD   A,%00110000       JR   Z,DST01       LD   A,%00100000DST01       LD   IX,DESTWN       LD   (IX+#04),A       LD   A,#01       LD   C,#61       RST  #10       LD   C,#66       RST  #10       LD   A,#01       LD   C,#0B       RST  #10       LD   HL,#010D       LD   C,#6B       RST  #10       POP  AF       PUSH AF       OR   A       LD   HL,L62FC       JR   Z,DST02       LD   HL,L62FDDST02       LD   A,"A"       ADD  A,(HL)       LD   (DSKLET + 1),A       LD   HL,DSKLET       LD   B,#03       LD   C,#6D       RST  #10       LD   HL,#0304       LD   C,#6B       RST  #10       POP  AF       OR   A       LD   HL,SRCTXT       JR   Z,DST03       LD   HL,DSTTXTDST03       LD   B,DSTXLN       LD   C,#6D       RST  #10       XOR  A       LD   C,#0B       RST  #10       RETL6015  CALL L687F        ; странный цикл с выбором адреса списка (?)       LD   A,(CPDFLG)       OR   A       JP   NZ,COPDIR	CALL L6059	RET  C	LD   A,(L62FD)	LD   DE,0L6020	EQU	$-#2	LD   HL,0L6023  EQU  $-#2         ; адрес тела канала текущей панели	LD   (HL),A	INC  HL	LD   (HL),E	INC  HL	LD   (HL),D	INC  HL	LD   A,(L5DC3)	BIT  3,A	JR   Z,L6045	LD   A,(L62FC)	LD   DE,0L6036	EQU	$-#2	LD   B,A       LD   C,#1C       ; переключение блочных устройств	RST  #10	RET  C       LD   C,#F        ; настройка драйвера на диск	RST  #10	RET  C       LD   C,#21       ; открыть каталог	RST  #10	RET  CL6045	XOR  A       LD   A,#F6       ; выход       RETL6049	LD   C,#2	RST  #10	RET  C;       CALL L5FF1        ; вывод окна с надписью SOURCE	LD   A,(L5DC3)       BIT  3,A       JR   NZ,L6050       PUSH AF       LD   A,#01       LD   (L6055),A       XOR  A;       CALL Z,L5FF1       CALL DSTWIN       POP  AFL6050       CALL L630A        ; запрос нажатия клавиш Enter       LD   A,0L6055  EQU  $ - 1       OR   A       JR   Z,L6058       LD   IX,DESTWN       CALL BLNKWN       XOR  A       LD   (L6055),AL6058       CALL L6555L6059	LD   A,(L62FC)	LD   DE,(L6036)       CALL L637E        ; открыть диск и каталог источника	RET  C	LD   A,(L6094)L6067	LD   (L6094),A       CALL L636A        ; получили дескриптор файла       JR   NC,L6081     ; читаем следующий файл	JP   L6136L6081  BIT  7,C           ; C-байт состояния отметки       JR   NZ,L6089      ; поднят 7-й бит - переходим к следующему файлу       BIT  6,C           ; проверка частичного копирования 1-продолжаем	JR   Z,L608FL6089	LD   A,(L6094)	INC  A	JR   L6067L608F	LD   (L60DD),DE	LD   DE,0L6094	EQU	$-#2	XOR  A       CALL L6343       ; вернуть в IX адрес дескриптора, в HL - размер файла в блоках	RET  C	LD   (L63C3),HL       EXX	LD   DE,0L60B0	EQU	$-#2	LD   (L60F5),DE       LD   BC,#000C       LDIR             ; в область дескрипторов копируем дескриптор копируемого файла	DEC  DE	EX   DE,HL	LD   A,#0L60BE	EQU	$-#1       BIT  6,(HL)      ; проверяем сегментированный/непрерывный       JR   Z,L60CB     ; сегментированный - переходим       BIT  2,A         ; проверка ключа /S	JR   Z,L60D1	RES  6,(HL)	JR   L60D1L60CB  BIT  1,A         ; проверка ключа /C	JR   Z,L60D1	SET  6,(HL)L60D1	EX   DE,HL       LD   BC,#0014	INC  DE       LDIR              ; копируем остальные 20 байт дескриптора из кэша	LD   (L60B0),DE	LD   DE,0L60DD	EQU	$-#2       CALL L633E        ; открыть файл по номеру в E	RET  C       CALL L635E        ; по номеру файла в каталоге в E возвращает в A номер отметки	BIT  4,A	JR   Z,L60F0	LD   A,#0L60EB	EQU	$-#1	LD   HL,(L60F5)	LD   (HL),AL60F0;       LD   IX,L5E9A       LD   IX,MWINV	LD   DE,0L60F5	EQU	$-#2       CALL WRFRFL       CALL L639D       ; читаем в буфер файл, если влезает, или весь буфер, если не влезает	RET  C	PUSH AF	POP  HL	LD   (L612F),HL	CALL L635E       LD   A,(L60BE)    ; проверяем бит move       RRA       JR   NC,L611F     ; если сброшен-идём дальше, иначе-удаляем	LD   A,(HL)	BIT  6,A       JR   Z,L611F      ; сброшен 6-й бит - пропускаем удаление	LD   A,(L60DD)	LD   C,#26	RST  #10	RET  C	LD   C,#3C	RST  #10	RET  C	CALL L635EL611F  RES  7,(HL)       ; отмечаем в отметке файла бит "прочитан"	LD   A,#0L6122	EQU	$-#1	INC  A	LD   (L6122),A	LD   DE,(L5DC5)       CP   E           ; сравниваем с максимальным количеством читаемых файлов       JR   Z,L6136     ; если достигли - идём на запись	LD   DE,0L612F	EQU	$-#2	PUSH DE	POP  AF       JP   Z,L6089     ; по результату L639D переходим к следующему файлуL6136  LD   A,(L60BE)   ; переходим сюда, когда надо записать файлы       RRA	JR   NC,L6140	LD   C,#2	RST  #10	RET  CL6140;       LD   IX,L5ECE;       CALL L5FF5       ; вывод окна DESTINATION	LD   A,(L5DC3)       BIT  3,A       JR   NZ,L614A       PUSH AF;       LD   IX,L5ECE;       CALL L5FF5       LD   A,#01       LD   (L6150),A       CALL DSTWIN       POP  AFL614A       BIT  2,A       JP   Z,L62DE;       JP   Z,L62DEL614F  CALL L630A       LD   A,#00L6150  EQU  $ - 1       OR   A       JR   Z,L6152       LD   IX,DESTWN       CALL BLNKWN       XOR  A       LD   (L6150),AL6152  CALL L6555       ; сброс кэша на 12 блоков	LD   A,(L62FD)	LD   DE,(L6020)       CALL L637E       ; переключение блочного устройства, открытие каталога (для записи)	RET  C	LD   A,#0L6161	EQU	$-#1	LD   (L6161),AL6162	EQU	$-#3	CALL L636A	LD   (L60DD),DE	JP   C,L629A	BIT  5,C	JP   Z,L6049	BIT  4,C	JP   NZ,L6251	LD   HL,(L60B0)	LD   A,(HL)	LD   (L60EB),AL6180  CALL L6326       ; проверяем наличие целевого файла       JP   C,L6204     ; ошибка открытия файла с именем записи - переходим       LD   A,(L5DC3)   ; здесь идёт ветка запроса перезаписи файла       RRA	JP   NC,L6292       RRA       JP   NC,L61F7       CALL FLPTST       RET  C       LD   IX,OWINV       PUSH IX       LD   A,#01       LD   C,#61       RST  #10       LD   IX,LTEFWN       LD   A,#FF       LD   C,#61       RST  #10       LD   IX,OVPO01       LD   A,#FF       LD   C,#61       RST  #10       POP  IX       LD   C,#66       RST  #10       LD   HL,#0202       LD   (OVNFCR),HL       LD   HL,FNBUF       LD   (OVNFAD),HL       LD   B,3OVNFPR       PUSH BC       LD   HL,(OVNFCR)       LD   C,#6B       RST  #10       INC  H       LD   (OVNFCR),HL       LD   HL,(OVNFAD)       LD   B,23       LD   C,#6D       RST  #10       LD   BC,23       ADD  HL,BC       LD   (OVNFAD),HL       POP  BC       DJNZ OVNFPROVKIN       LD   C,#08       RST  #10       DEC  C       RST  #10       CP   #10       JP   Z,L629A    ; Выход       CP   "a"       JR   Z,TOGFLG       CP   "A"       JR   Z,TOGFLG       CP   #09        ; стрелка вправо       JR   Z,OVRGT       CP   #08        ; стрелка влево       JR   Z,OVLFT       CP   #0D       JP   Z,OVEND       JR   OVKINOVNFCR       DEFW #0202OVNFAD       DEFW FNBUFTOGFLG       LD   IX,OWINV       LD   HL,#0603       LD   C,#6B       RST  #10       LD   HL,OVFLG       LD   A,#01       XOR  (HL)       LD   (HL),A       LD   A,#20       JR   Z,TOGF01       LD   A,#FBTOGF01       LD   (OVFLGW),A       LD   C,#0A       RST  #10       JR   OVKINOVRGT       LD   A,(OVPOS)       CP   #03       JR   NC,OVKIN       OR   #80       CALL OVPBUT       AND  #03       INC  A       LD   (OVPOS),A       CALL OVPBUT       JR   OVKINOVLFT       LD   A,(OVPOS)       CP   #02       JP   C,OVKIN       OR   #80       CALL OVPBUT       AND  #03       DEC  A       LD   (OVPOS),A       CALL OVPBUT       JP   OVKINOVPBUT       LD   IX,OVPO01       LD   HL,OVPBED       LD   B,A       RES  7,B       PUSH AFOVPB01       DEC  HL       DEC  HL       DJNZ OVPB01       AND  #80       LD   A,%00101000  ; цвет подсветки кнопок, заменить на цвет из UnCo       JR   Z,OVPB02       LD   A,(OWINV+#04)OVPB02       LD   (IX+#04),A       LD   A,(HL)       LD   (IX+#03),A       INC  HL       LD   A,(HL)       LD   (IX+#00),A       LD   A,#FF       LD   C,#61       RST  #10       POP  AF       RETOVEND       LD   A,(OVPOS)       CP   #03       JP   Z,L629A       LD   IX,OWINV       CALL BLNKWN       LD    A,(OVFLG)       OR   A       LD   A,(OVPOS)       JR   NZ,OVEN01       CP   #02       JP   Z,L6292       JR   L61F7OVEN01                  ; флажок "применить ко всем" поднят       CP   #02       JP   Z,L628DL61F2                   ; Overwrite all	LD   HL,L5DC3	RES  1,(HL)L61F7	LD   C,#35	RST  #10       EXX	XOR  A	LD   (HL),A	LD   C,#28	RST  #10	RET  C	JP   L6180L6204  CP   #51         ; проверяем код ошибки 81 - файл не существует       SCF       RET  NZ          ; на выход с ошибкой, если ошибка другая	LD   HL,(L60B0)       LD   C,#50       ; проверяем на корректность имя файла	XOR  A	RST  #10	RET  C	PUSH HL       LD   BC,#000F	ADD  HL,BC	LD   E,(HL)	INC  HL	LD   D,(HL)	LD   (HL),B	LD   (L623A),HL	INC  D	DEC  D	JR   NZ,L622B	LD   A,E	INC  A	JR   Z,L622B	POP  HL       LD   C,#3B       ; создание целевого файла	RST  #10	RET  C	JR   L6251L622B	DEC  HL	RES  7,(HL)	DEC  HL	DEC  HL	DEC  HL	DEC  HL	LD   (HL),#1	POP  HL       LD   C,#3B       ; создание целевого файла	RST  #10	RET  C	LD   HL,0L623A	EQU	$-#2	LD   (HL),D	DEC  HL	LD   (HL),E	LD   A,E	AND  #80	OR   D	JR   Z,L6251       RLCA       RLCA	LD   B,AL6248	LD   DE,L4000       LD   C,#31        ; добавить в конец файла DE байт	RST  #10	RET  C	DJNZ L6248L6251  CALL L6326        ; открываем файл по имени	RET  CL6255  CALL L5FC4        ; стираем окно Over-Skip-Quit	CALL L6422	RET  C	CALL L635E	BIT  7,A	JR   NZ,L6279;       PUSH AF       LD   (STA01),A;       LD   IX,L5EAD;       LD   DE,(L60B0);       CALL L5FFD        ; рисуем правое окно с записываемым файлом       LD   HL,(L60B0)       LD   C,#25       RST  #10       RET  C       LD   IX,MWINV       CALL WRTOFL       LD   A,#00STA01  EQU  $ -1;       POP  AF	BIT  6,A	JP   Z,L6049       CALL L6326        ; открываем записаный файл по имени	RET  CL6279	LD   A,(L6161)	LD   HL,(L60B0)	LD   BC,L20	ADD  HL,BC	LD   (L60B0),HL	INC  A	LD   (L6161),A	JP   L6162L628D  LD   HL,L5DC3     ; Перезаписать все	RES  0,(HL)L6292  CALL L635E        ; перезаписать файл	SET  7,A	LD   (HL),A	JR   L6255L629A	LD   C,#2	RST  #10	RET  C	CALL L62A4	RET  C	XOR  A       RETL62A4	LD   DE,0L62A7	LD   (L60DD),DE	CALL L6343	JR   C,L62D0	LD   A,(IX+#B)       RRA	JR   NC,L62C2	PUSH IX	POP  HL	XOR  A	CP   (HL)	JR   NZ,L62C2	LD   C,#24	RST  #10	JR   C,L62D0L62C2	LD   DE,(L60DD)	INC  DE	LD   A,#7F	CP   E	JR   NZ,L62A7L62CC	LD   C,#2	RST  #10       RETL62D0	CP   #59	JR   Z,L62C2	CP   #50	JR   Z,L62CC	CP   #65	JR   Z,L62CC       SCF       RETL62DE	SET  2,A	LD   (L5DC3),A       CALL L630A       ; если поднят флаг, запрашиваем нажатия клавиш       JR   NZ,L6307    ; кнопки не нажимали, преходим       CALL L6555       ; пересоздание кэшаL62EB	CALL L653D	RET  C	JR   Z,L62F8	CALL L5FA1	RET  C       PUSH AF       CALL LTSWCL       POP  AF	JR   Z,L62EB       RETL62F8;      CALL L5FC4	LD   HL,0L62FC  EQU  $-#2        ; номер диска откуда копировать	LD   A,LL62FD  EQU  $-#2        ; номер диска куда копировать	SUB  H	JR   Z,L6307	LD   HL,L5DC3	SET  3,(HL)L6307	JP   L6152L630A	BIT  3,A	RET  NZL630D  LD   C,#8        ; обработка нажатий клавиш, например, при смене дисков	RST  #10	DEC  C	RST  #10	CP   #D	RET  Z	CP   #17	JR   Z,L6320	CP   #10	JR   NZ,L630D	LD   C,#80	RST  #10L6320	LD   HL,L5DC3	SET  3,(HL)	RET  ZL6326	LD   HL,(L60B0)	PUSH HL	LD   DE,L6532	LD   B,#BL632F	LD   A,(DE)       CP   #FF         ; проверяем файл по маске	JR   Z,L6335	LD   (HL),AL6335	INC  HL	INC  DE	DJNZ L632F	POP  HL       LD   C,#34       ; пробуем перед записью файла открыть файл с этим именем	RST  #10       RETL633E	LD   A,E	LD   C,#26	RST  #10       RETL6343	LD   DE,(L60DD)	LD   C,#27	RST  #10	RET  C       EXXL634C	PUSH HL       EXX	POP  IX	LD   L,(IX+#F)	LD   H,(IX+#10)	LD   A,(IX+#E)	OR   A	RET  Z	INC  HL       RETL635D	JP   (HL); L60DD - номер файла в каталоге; возвращает в HL-адрес байта состояния отметки файлаL635E  LD   DE,(L60DD)L6362	LD   C,#86	RST  #10       EXX	PUSH HL       EXX	POP  HL       RET; Подпрограмма принимает номер отмеченного файла; возвращает в HL-дескриптор, C-байт состоянияL636A  LD   B,A	XOR  A	LD   E,A; перебираем файлы в каталоге, ищем следующий файлL636D  LD   A,#0         ; максимальный номер файла в каталогеL636E	EQU	$-#1	CP   E       RET  C            ; возвращаемся, если список файлов закончился	PUSH BC	CALL L6362	POP  BC	LD   C,(HL)	DEC  HL	LD   A,(HL)	CP   B       RET  Z            ; возвращаемся, если нашли файл	INC  E	JR   L636DL637E	LD   B,A       LD   C,#1C        ; переключить блочное устройство	RST  #10	RET  C	LD   A,(L5DC3)	BIT  3,A	JR   NZ,L638E       LD   C,#F         ; диск тотже - автонастройка диска	RST  #10	RET  CL638E  LD   C,#21        ; открыть каталог	RST  #10	RET  C	XOR  A	LD   (L6122),A	LD   HL,L6575	LD   (L60B0),HL       RETL639D	LD   A,#FFL639E	EQU	$-#1	OR   A       CALL NZ,L64B7    ; обнулили переменные	LD   (L639E),A       CALL L635E       ; получили в A байт состояния отметки	RES  7,A       BIT  5,A         ; сброшен 5-й бит - устанавливаем 5-й, 7-й биты	JR   NZ,L63BA	SET  5,A	SET  7,A	LD   DE,0	LD   (L63C6),DEL63BA	LD   (HL),AL63BB	CALL L635E	BIT  6,A       JR   NZ,L6420       LD   HL,0        ; размер текущего файла в блокахL63C3	EQU	$-#2	LD   DE,0L63C6  EQU  $-#2        ; с какого блока читаем открытый файл	OR   A	SBC  HL,DE	PUSH HL       CALL L64D3       ; расчёт чтения количества блоков за одну операцию размер в блоках в HL       POP  DE          ; количество блоков файла, которые надо прочитать	XOR  A	CP   D       JR   NZ,L63E2    ; в D не 0 - файл длиннее 255 блоков	LD   A,E	CP   L       JR   C,L6403     ; остаток файла меньше размера буфера       JR   NZ,L63E2    ; остаток файла больше размера буфера       PUSH HL          ; равен размеру буфера	CALL L635E	SET  6,A	LD   (HL),A	POP  HLL63E2	LD   B,L	PUSH HL       CALL L64F9       ; расчёт с какого адреса располагать данные в памяти	LD   DE,(L63C6)	LD   C,#2B	RST  #10	POP  HL	RET  C	LD   DE,(L63C6)	ADD  HL,DE	LD   (L63C6),HL       CALL L6504       ; обмен 8кб из буфера с расширенной памятью       JR   NZ,L63BB    ; сохранён не весь буфер в верхней памяти - переход на следующий заход	CALL L6504	XOR  A	INC  A       RETL6403	PUSH DE	CALL L635E	SET  6,A	LD   (HL),A	POP  DE	LD   B,E	PUSH DE	CALL L64F9	LD   DE,(L63C6)       LD   C,#2B        ; читаем B блоков по адресу в HL	RST  #10	POP  DE	RET  C	LD   HL,0L641A	EQU	$-#2	ADD  HL,DE	LD   (L641A),HLL6420	XOR  A       RETL6422	LD   A,(L639E)	OR   A	CALL Z,L64C5	XOR  A       CPL	LD   (L639E),A	CALL L635E	BIT  4,A	JR   NZ,L643E	SET  4,A	LD   DE,0	LD   (L6453),DEL643E	LD   (HL),A	LD   (L6479),AL6442	CALL L635E	LD   HL,(L63C6)	BIT  6,A	JR   Z,L6452	LD   HL,(L60B0)	CALL L634CL6452	LD   DE,0L6453	EQU	$-#2	OR   A	SBC  HL,DE	PUSH HL	CALL L64D3	POP  DE	XOR  A	CP   D	JR   NZ,L646F	LD   A,E	CP   L	JR   C,L6499	JR   NZ,L646F	LD   A,(L639E)	RES  6,A	LD   (L639E),AL646F	LD   B,L	PUSH HL	CALL L64F9	LD   DE,(L6453)	LD   A,#0L6479	EQU	$-#1	BIT  7,A	JR   NZ,L6481       LD   C,#2C        ; запись B блоков в открытый файл с адреса в памяти в HL по смещению в файле в байтах в DE	RST  #10L6481	POP  HL	RET  C	LD   DE,(L6453)	ADD  HL,DE	LD   (L6453),HL	CALL L6504	CALL NZ,L64DE	LD   A,(L639E)	BIT  6,A	JR   NZ,L6442       RETL6499	PUSH DE	LD   B,E	CALL L64F9	LD   DE,(L6453)	LD   A,(L6479)	BIT  7,A	JR   NZ,L64AC	LD   C,#2C	RST  #10L64AC	POP  DE	RET  C	LD   HL,(L641A)	ADD  HL,DE	LD   (L641A),HL	XOR  A       RETL64B7	XOR  A	LD   (L64DF),AL64BB	LD   A,#0L64BC	EQU	$-#1	LD   (L64D4),AL64BD	EQU	$-#3	XOR  A	LD   (L641A),A       RETL64C5	CALL L6504	CALL Z,L6504	CALL L64B7	CALL L6504	JR   L64BBL64D3	LD   HL,0L64D4	EQU	$-#2	LD   DE,(L641A)	OR   A	SBC  HL,DE       RETL64DE	LD   A,#0L64DF	EQU	$-#1	DEC  A	CALL L64EB	LD   A,(HL)       JR   L64BDL64E8	LD   A,(L64DF)L64EB	SLA  A	LD   HL,0L64EE	EQU	$-#2	LD   B,#0	LD   C,A	ADD  HL,BC	LD   E,(HL)	INC  HL	LD   D,(HL)	EX   DE,HL       RETL64F9	LD   A,(L641A)       LD   HL,0         ; здесь будет #6975L64FD  EQU  $-#2         ; адрес, с которого начинается размещение данных	LD   D,A	XOR  A	LD   E,A	ADD  HL,DE       RETL6504	LD   A,(L5DC4)	DEC  A	RET  Z	CALL L64E8	LD   B,(HL)	INC  HL	LD   E,(HL)	INC  HL	LD   D,(HL)	EX   DE,HL       CALL L635D       ; копирование 8кб буфера в верхнюю память                        ; к этому моменту вычитали в B=#20 и в HL адрес перехода       CALL L64E8       ; вычислили адрес в списке                        ; выполнили процедуру переключения страиц памяти и обмен 8кб #6975 <-> #C000	LD   A,(HL)       CALL L64BD       ; сохранили переменные	LD   HL,(L5DC4)	LD   A,(L64DF)	INC  A	CP   L	RET  Z	LD   (L64DF),A	CALL L64E8	LD   A,(HL)	CALL L64BD	CP   #3       RETL6532	DEFB	#00	DEFB	#00	DEFB	#00	DEFB	#00	DEFB	#00	DEFB	#00	DEFB	#00	DEFB	#00	DEFB	#00	DEFB	#00	DEFB	#00L653D  LD   HL,L5F53	LD   C,#4B       RST  #10         ; открываем устройство по пути из буфера	JR   NC,L655E       CP   #51         ; нет такого каталога	JR   Z,L6552       CP   #9          ; не iSDOS устройство       SCF	RET  NZ       CALL L5FE0       ; печать "Not iS-DOS"	JR   L6555L6552  CALL L5FE6       ; печать "No path"L6555  LD   A,(L5DC6)   ; восстанавливаем кэш и выходим	LD   C,#0	RST  #10	XOR  A	INC  A       RETL655E  JR   NZ,L6552    ; PRO_81       EXX              ; имя выходного файла	LD   DE,L6532	LD   BC,LB       LDIR       LD   C,#33	RST  #10       LD   (L62FD),A   ; текущий диск       EXX       LD   (L6020),HL  ; текущий каталог	XOR  A       RETCOPDIR       LD   A,(L62FC)       LD   DE,(L6036)       CALL L637E        ; открыть диск и каталог источника       RET  C       LD   A,(L5DC4)       DEC  A       LD   A,(L64BC)       JR   Z,CPDR01       LD   A,#40       LD   (PGFRE),A       XOR  A       LD   (FRDFLG),A       LD   A,(L64FD+1)       LD   B,A       LD   A,#C0       SUB  B       LD   B,A       LD   A,(L64FD)       OR   A       JR   Z,CPDR02       DEC  BCPDR02       LD   A,(L64BC)       CP   B       JR   C,CPDR01       LD   A,B       LD   (L64BC),ACPDR01       LD   (BUFSIZ),A       LD   A,(BUFSIZ)       LD   (BUFBLK),A   ; инициализируем количество свободных блоков размером буфера       LD   A,(L60DD)       LD   C,#26       RST  #10       RET  C       EXX       PUSH HL       CALL FDREAD       POP  HL       JP   C,RECD4RECD11       PUSH HL       DEC  HL       LD   A,(HL)       ; получаем номер текущего каталога в каталоге уровнем выше       CALL RECD10       LD   (HL),A       ; запоминаем номер в мвссиве       LD   IX,MWINV       CALL WRFRFL       POP  HL       LD   BC,#0013     ; номер 0-го блока каталога по смещению 19       ADD  HL,BC       LD   E,(HL)       INC  HL       LD   D,(HL)       LD   C,#21       RST  #10       RET  C       LD   HL,CRLVL       INC  (HL)RECD12                   ; заходим сюда из процедуры записи       CALL RECD10RECD1       LD   A,(HL)       LD   C,#26       RST  #10       JP   NC,RECD3       CP   #50          ; проверяем на ошибку 80 (выход за список каталога)       SCF       RET  NZ; ветка возвращения на уровень выше и удаления каталога из которого вышли       XOR  A            ; перебрали все файлы в каталоге, возвращаемся на уровень выше       LD   C,#26       RST  #10       RET  C       EXX       LD   BC,#000C       ADD  HL,BC       LD   E,(HL)       INC  HL       LD   D,(HL)       LD   C,#21       RST  #10       RET  C       LD   HL,(FDCUR)       LD   DE,#0019       OR   A       ADC  HL,DE       INC  (HL)       CALL RECD10       LD   (HL),#00       LD   HL,CRLVL       DEC  (HL)       JP   Z,WECD      ; вернулись на 0-й уровень                        ; обошли все файлы, финальная запись       JP   RECD2       ; возвращаемся на уровень выше, переходим к следующему файлуRECD3       OR   A       JP   Z,RECD2     ; открыли файл с номером 0, это текущий каталог; здесь открыт файл и с ним можно проводить действия; HL'-адрес системного дескриптора открытого файла       EXX       PUSH HL       LD   BC,#000B       ADD  HL,BC       LD   A,(HL)       POP  HL       BIT  0,A         ; файл не удалён?       JP   Z,RECD2     ; файл/каталог удалён, пропускаем; здесь должно быть копирование дескриптора файла/каталога в массив; сохранить A и HL       PUSH HL       LD   B,A       PUSH BC       CALL FDREAD       POP  BC       LD   A,B       POP  HL       JP   C,WECD      ; достигнут предел количества считанных дескрипторов (32) - переход на запись       BIT  5,A         ; проверяем-открытый файл каталог?       JP   NZ,RECD11RECD33       PUSH HL       LD   HL,(FDNXT)       LD   DE,#0020       OR   A       SBC  HL,DE       LD   DE,(FDSTT)       XOR  A       SBC  HL,DE       JR   NZ,REC371       LD   A,#FFREC371       LD   (FSTFLG),A       LD   A,(BUFBLK)       LD   B,A       LD   A,(BUFSIZ)       SUB  B       LD   D,A       XOR  A       LD   E,A       LD   HL,(L64FD)       ADD  HL,DE       ; вычисляем адрес куда считывать       EX   DE,HL       POP  HL       PUSH HL       PUSH DE       CALL L634C       ; вычисляем размер в блоках текущего открытого файла       LD   DE,#0000       LD   A,(FRDFLG)       OR   A       JR   Z,REC370       LD   DE,(FSTBL1)       JR   RECD37REC370       LD   A,(FSTFLG)       OR   A       JR   Z,RECD37   ; если дескриптор первый, используем переменную FSTBLK       LD   DE,(FSTBLK)RECD37       OR   A       SBC  HL,DE       PUSH DE       LD   A,H       OR   A       JR   NZ,RECD35   ; переход, если остаток блоков больше 255       LD   A,(BUFBLK)       CP   L       JR   C,RECD35       LD   B,L         ; ветка, где остаток буфера больше остатка файла       SUB  B       LD   (BUFBLK),A  ; после расчёта количества считываемых блоков вычисляем остаток буфера       LD   HL,#0000       LD   (LSTBLK),HL ; обнуляем остаток блоков файла - файл влезает в буфер весь       JR   RECD36RECD35                  ; ветка, где остаток буфера меньше остатка файла       LD   HL,#0000       LD   A,(FRDFLG)       OR   A       JR   Z,REC351       LD   HL,(FSTBL1)       JR   RECD38REC351       LD   A,(FSTFLG)       OR   A       JR   Z,RECD38    ; если дескриптор первый, то уже заход не первый       LD   HL,(FSTBLK) ;RECD38       LD   A,(BUFBLK)       LD   B,A       LD   E,A       LD   D,#00       ADD  HL,DE       LD   (LSTBLK),HL       XOR  A       LD   (BUFBLK),A  ; обнуляем остаток буфераRECD36                  ; подходим к процедуре чтения       POP  DE       POP  HL       LD   C,#2B       RST  #10       POP  HL           ; вспоминаем адрес дескриптора       RET  C       LD   IX,MWINV       LD   A,(FSTFLG)       LD   B,A       LD   A,(FRDFLG)       OR   B       CALL Z,WRFRFL       ; адрес дескриптора нужен для вывода имени копируемого файла       XOR  A       LD   (FRDFLG),A       LD   A,(BUFBLK)       OR   A       JP   NZ,RECD2;       JR   Z,WECD       ; буфер забит, нужен переход на процедуру записи       LD   A,(L5DC4)       DEC  A       JP   Z,WECDPRSW03       CALL PGRD10       LD   A,(HL)       OR   A       JP   Z,WECD        ; забиты все страницы, забита память, пора писать       LD   A,(PGFRE)       LD   B,A       LD   A,#40       SUB  B       LD   D,A       LD   E,#00       LD   HL,#C000       ADD  HL,DE       PUSH HL            ; вычислили адрес куда копировать       LD   A,(BUFBLK)       LD   D,A       LD   HL,(L64FD)       ADD  HL,DE       PUSH HL            ; адрес откуда копировать       LD   C,A       LD   A,(BUFSIZ)       SUB  C       CP   B       JR   NC,PRSW02       LD   B,APRSW02       LD   C,#00       POP  HL       POP  DE       PUSH BC       EXX       CALL PGRD10       LD   A,(HL)       LD   BC,#7FFD       DI       OUT  (C),A       EXX       LDIR       EXX       LD   A,#10       OUT  (C),A       EI       EXX       POP  BC          ; B-количество скопированных блоков       LD   A,(PGFRE)       SUB  B       JR   NZ,PRSW01       LD   HL,PGRDR    ; выбрали всю страницу, переходим на новую       INC  (HL)       LD   A,#40PRSW01       LD   (PGFRE),A       LD   A,(BUFSIZ)       LD   C,A       LD   A,(BUFBLK)       ADD  A,B         ; считаем, на сколько расчистили буфер в памяти       LD   (BUFBLK),A       CP   C       JR   C,PRSW03    ; если не весь, идём на следующую итерацию копирования       CALL BLUMFR      ; возвращает в HL количество свободных блоков в верхней памяти       LD   A,(BUFSIZ)       LD   E,A       LD   A,L       OR   A       SBC  HL,DE       ; сравниваем количество свободных блоков и размер буфера       JR   NC,PRSW07       LD   (BUFSIZ),A  ; если следующая партия не влезет, уменьшаем буферPRSW07       CALL PGRD10       LD   A,(HL)       OR   A       JR   NZ,PRSW08       LD   A,(L64BC)   ; если страниц больше не осталось - восстанавливаем размер буфера       LD   (BUFSIZ),APRSW08       LD   A,(BUFSIZ)       LD   (BUFBLK),A       LD   HL,(LSTBLK)       LD   (FSTBL1),HL       LD   A,#FF       LD   (FRDFLG),A       LD   C,#35       RST  #10       EXX       PUSH HL       EXX       LD   HL,(LSTBLK)       XOR  A       OR   H       OR   L       POP  HL       JP   NZ,RECD33RECD2                 CALL RECD10       INC  (HL)       JP   RECD1RECD4       LD   C,#10       RST  #10       EXX       LD   BC,#FFFA       ADD  HL,BC       LD   A,(HL)       LD   C,#00       RST  #10       RET  C       JP   L6045; Процедура записиWECD       LD   C,#33       RST  #10       EXX       LD   (L6036),HL       LD   A,(L62FD)       LD   DE,(L6020)       CALL L637E       RET  C       LD   A,(L5DC4)       DEC  A       JP   Z,WENX12       XOR  A       LD   (PGWRI),A       LD   (FRDFLG),A       LD   HL,#0000       LD   (FSTBL1),HL       CALL BLUMFR       LD   A,(BUFBLK)       LD   B,A       LD   A,(BUFSIZ)       SUB  B       JP   Z,WENX12       LD   E,A       LD   D,#00       OR   A       SBC  HL,DE       JP   C,WENX11; ветка, где буфер просто копируется в расширенную память; он туда влезает       XOR  A       LD   (BWBLK),APWSW03       LD   A,(PGFRE)       LD   B,A       LD   A,#40       SUB  B       LD   D,A       LD   E,#00       LD   HL,#C000       ADD  HL,DE       PUSH HL            ; вычислили адрес куда копировать       LD   A,(BWBLK)       LD   D,A       LD   HL,(L64FD)       ADD  HL,DE       PUSH HL            ; адрес откуда копировать       LD   A,(BUFBLK)       LD   C,A       LD   A,(BUFSIZ)       SUB  C       LD   D,A       LD   A,(BWBLK)       LD   C,A       LD   A,D       SUB  C       CP   B       JR   NC,PWSW02       LD   B,APWSW02       LD   C,#00       POP  HL       POP  DE       PUSH BC       EXX       CALL PGRD10       LD   A,(HL)       LD   BC,#7FFD       DI       OUT  (C),A       EXX       LDIR       EXX       LD   A,#10       OUT  (C),A       EI       EXX       POP  BC          ; B-количество скопированных блоков       LD   A,(PGFRE)       SUB  B       JR   NZ,PWSW01       LD   HL,PGRDR    ; выбрали всю страницу, переходим на новую       INC  (HL)       LD   A,#40PWSW01       LD   (PGFRE),A       LD   A,(BUFBLK)       LD   C,A       LD   A,(BUFSIZ)       SUB  C       LD   C,A       LD   A,(BWBLK)       ADD  A,B       LD   (BWBLK),A       CP   C       JR   C,PWSW03    ; если не весь, идём на следующую итерацию копирования       XOR  A       LD   (PGWRI),A       LD   A,#40       LD   (PGFRE),A       LD   A,(L64BC)       LD   (BUFSIZ),A       CALL PUSW       XOR  A       LD   (PFULG),A       JR   WENX12WENX11; ветка, где происходит обмен блоками с расширеной памятью; на размер буфера       LD   A,#40       LD   (BWBLK),A       XOR  A       LD   (BUFBLK),APVSW03       LD   A,(BWBLK)       LD   B,A       LD   A,#40       SUB  B       LD   D,A       LD   E,#00       LD   HL,#C000       ADD  HL,DE       PUSH HL            ; вычислили адрес откуда копировать       LD   A,(BUFBLK)       LD   D,A       LD   HL,(L64FD)       ADD  HL,DE       PUSH HL            ; адрес откуда копировать       LD   C,A       LD   A,(BUFSIZ)       SUB  C       CP   B       JR   NC,PVSW02       LD   B,APVSW02       LD   C,#00       POP  DE       POP  HL       PUSH BC       EXX       CALL PGWR10       LD   A,(HL)       LD   BC,#7FFD       DI       OUT  (C),A       EXX1$       LD   A,(DE)       EX   AF,AF'       LD   A,(HL)       LD   (DE),A       EX   AF,AF'       LD   (HL),A       INC  HL       INC  DE       DEC  BC       XOR  A       OR   B       OR   C       JR   NZ,1$       EXX       LD   A,#10       OUT  (C),A       EI       EXX       POP  BC          ; B-количество скопированных блоков       LD   A,(BWBLK)       SUB  B       JR   NZ,PVSW01       LD   HL,PGWRI    ; выбрали всю страницу, переходим на новую       INC  (HL)       LD   A,#40PVSW01       LD   (BWBLK),A       LD   A,(BUFSIZ)       LD   C,A       LD   A,(BUFBLK)       ADD  A,B       LD   (BUFBLK),A       CP   C       JR   C,PVSW03    ; если не весь, идём на следующую итерацию копирования       LD   A,#FF       LD   (PFULG),A       LD   A,(BWBLK)       LD   (PGFRE),AWENX12       LD   A,(BUFSIZ)       LD   (BUFBLK),A       LD   HL,(FDSTT)WENX01       LD   (FDWRI),HL       PUSH HL       LD   BC,#0019       ADD  HL,BC       LD   A,(HL)       LD   (DEPB25),A       LD   (HL),#00       POP  HL       LD   BC,#000B       ADD  HL,BC       BIT  5,(HL)       JP   Z,WECDFL; дескриптор каталога       LD   HL,(FDWRI)       LD   C,#25       RST  #10       JP   NC,WECD01       CP   #51       SCF       RET  NZ       LD   HL,(FDWRI)       PUSH HL       LD   BC,#000C       PUSH BC       ADD  HL,BC       XOR  A       LD   (HL),A       INC  HL       LD   (HL),A       LD   BC,#0004       ADD  HL,BC       LD   D,H       LD   E,L       INC  DE       POP  BC       LD   (HL),A       LDIR       POP  HL; Процедура создания, HL - адрес дескриптора;MKDIR       PUSH HL       POP  IX       LD   C,#23        ; Создаём каталог       RST  #10       RET  C       EXX       LD   BC,#000B       ADD  HL,BC       LD   A,(HL)       ; A - регистр состояния       LD   C,#6       ADD  HL,BC       LD   E,(HL)       INC  HL       LD   D,(HL)       ; DE - номер блока описателя сегментов       AND  #40          ; Проверка 6-го бита непрерывный ли файл?       JR   NZ,MKD01     ; каталог непрерывный - переходим       RST  #10          ; блок номер DE считываем в кэш       RET  C       EXX       INC  HL       LD   E,(HL)       INC  HL       LD   D,(HL)       PUSH DE       EXX       POP  DEMKD01  INC  HL       LD   (HL),E       INC  HL       LD   (HL),D       LD   C,#28       RST  #10       RET  C       PUSH DE       LD   BC,#FFEC       ADD  HL,BC       LD   BC,#0020       PUSH IX       POP  DE       LDIR             ; копируем в локальный дескриптор внутренний дескриптор с обновлёнными данными       LD   C,#10       ; далее заполняем дескриптор дефолтным содержимым (1 элемент каталога и т.д. )       ADD  HL,BC       LD   A,(HL)       INC  HL       INC  HL       INC  HL       LD   E,(HL)       INC  HL       LD   D,(HL)       INC  HL       INC  HL       INC  HL       OR   (HL)       INC  A       LD   (IX+#0C),E       LD   (IX+#0D),D       LD   (IX+#17),A       LD   (IX+#15),#01       POP  DE       LD   C,#6        ; считываем первый блок каталога       RST  #10       RET  C       EXX       PUSH DE       EX   DE,HL       PUSH IX       POP  HL       LD   BC,#0020       LDIR             ; заполняем первый элемент каталога своим же дескриптором       LD   C,#DF       LD   L,E       LD   H,D       INC  DE       LD   (HL),#0       LDIR             ; остальная часть блока - нули       POP  DE       LD   C,#2E       ; помечаем блок в кэше как модифицированный       RST  #10       RET  C; В регистре A - вычисляем количество блоков, подлежащих забивке нулями       LD   L,(IX+#0E)       LD   H,(IX+#0F)       LD   A,L       OR   A       LD   A,H       JR   NZ,MKD02       DEC  AMKD02  OR   A       JR   Z,MKD05       LD   B,A       LD   DE,#0001; цикл забивки нулями блоков каталога, следующих за первымMKD03  LD   C,#2D      ; читаем блок в кэш       RST  #10       RET  C       EXX             ; получаем в HL' адрес блока в кэше       XOR  A       LD   B,AMKD04  LD   (HL),A     ; пишем в блок нули       INC  HL       DJNZ MKD04       PUSH DE       EXX       POP  HL       EX   DE,HL       LD   C,#2E      ; помечаем блок в кэше как модифицированный       RST  #10       RET  C       EX   DE,HL       INC  DE       DJNZ MKD03MKD05       LD   C,#2       RST  #10       RET  C       LD   IX,MWINV       CALL WRTOFL       ; адрес дескриптора нужен для вывода имени копируемого файла       LD   HL,(FDWRI)       LD   BC,#0013       ADD  HL,BC       LD   E,(HL)       INC  HL       LD   D,(HL)       LD   C,#21       RST  #10       RET  C       JP   WECDNXWECD01       OR   A       SCF       RET  Z       JP   WECDNX; дескриптор файлаWECDFL       LD   IX,(FDWRI)       XOR  A       LD   (IX+#11),A       LD   (IX+#12),A       PUSH IX       POP  HL       LD   C,#25       RST  #10       JR   NC,WECDF2WECDF1       CP   #51       SCF       RET  NZ       LD   HL,(FDWRI)       PUSH HL       LD   BC,#000B       ADD  HL,BC       XOR  A       LD   D,#00       BIT  6,(HL)      ; если файл непрерывный, манипуляции с добавлением блоков не делаем       JR   NZ,WCDF13       LD   BC,#0004       ADD  HL,BC       LD   E,(HL)       LD   A,(HL)       LD   (SVLEN),A       RES  7,(HL)       INC  HL       LD   D,(HL)       LD   A,(HL)       LD   (SVLEN+1),A       LD   (HL),#00       LD   A,E       AND  #80WCDF13       OR   D       POP  HL       PUSH AF       LD   C,#3B       RST  #10       POP  BC       RET  C       PUSH BC       POP  AF       JR   Z,WCDF11       RLCA       RLCA       LD   B,AWCDF12       LD   DE,#4000       LD   C,#31       RST  #10       DJNZ WCDF12       LD   HL,(FDWRI)       LD   BC,#000F       ADD  HL,BC       LD   A,(SVLEN)       LD   (HL),A       INC  HL       LD   A,(SVLEN+1)       LD   (HL),AWCDF11       LD   C,#02       RST  #10       RET  CWECDF2       LD   HL,(FDWRI)       PUSH HL       LD   A,(BUFBLK)       LD   B,A       LD   A,(BUFSIZ)       SUB  B       LD   D,A       XOR  A       LD   E,A       LD   HL,(L64FD)       ADD  HL,DE       ; вычисляем адрес откуда считывать       EX   DE,HL       POP  HL       PUSH HL       PUSH DE       CALL L634C       ; вычисляем размер в блоках текущего открытого файла       PUSH HL          ; запоминаем в стеке       LD   A,(FRDFLG)       OR   A       JR   Z,1$       LD   DE,(FSTBL1)       JR   WECF011$       LD   HL,(FDWRI)       LD   DE,(FDSTT)       OR   A       SBC  HL,DE       LD   DE,#0000;       LD   A,#00       JR   NZ,WECF01   ; если дескриптор первый, используем переменную FSTBLK       LD   DE,(FSTBLK);       LD   A,#FFWECF01;       LD   (FSTFLG),A       POP  HL       OR   A       SBC  HL,DE       PUSH DE       LD   A,H       OR   A       JR   NZ,WECF02   ; переход, если остаток блоков больше 255       LD   A,(BUFBLK)       CP   L       JR   C,WECF02       LD   B,L         ; ветка, где остаток буфера больше остатка файла       SUB  B       LD   (BUFBLK),A  ; после расчёта количества считываемых блоков вычисляем остаток буфера       LD   HL,#0000       LD   (LSTBL1),HL       XOR  A       LD   (UFFLG),A       JR   WECF03WECF02;       LD   A,(FSTFLG);       OR   A;       LD   HL,#0000;       JR   Z,RECD38    ; если дескриптор первый, то уже заход не первый;       LD   HL,(FSTBLK) ;;RECD38;       LD   A,(L5DC4);       DEC  A;       JR   Z,1$       EX   DE,HL       LD   A,(BUFBLK)       LD   B,A       LD   D,#00       LD   E,A       ADD  HL,DE       LD   (LSTBL1),HL       LD   A,#FF       LD   (UFFLG),A;1$;       LD   E,A;       LD   D,0;       ADD  HL,DE;       LD   (LSTBLK),HL       XOR  A       LD   (BUFBLK),A  ; обнуляем остаток буфераWECF03       POP  DE       POP  HL       LD   C,#2C       RST  #10       POP  HL           ; вспоминаем адрес дескриптора       RET  C       LD   IX,MWINV       CALL WRTOFL       LD   A,(L5DC4)       DEC  A       JR   Z,WECDNX       XOR  A       LD   (FRDFLG),A       LD   HL,(LSTBL1)       LD   (FSTBL1),HL       LD   A,(BUFBLK)       OR   A       JR   NZ,WECDNX       CALL PGWR10       LD   A,(HL)       OR   A       JR   NZ,PGWR01       LD   A,(L64BC)       LD   (BUFSIZ),A       LD   A,(PFULG)       OR   A       JR   Z,WECDNX       XOR  A       LD   (PGWRI),A       LD   A,#40       LD   (PGFRE),A       CALL PUSW       XOR  A       LD   (PFULG),A       LD   A,#05       LD   (PGWRI),A       JR   PGWR03PGWR01       CALL BLUMFW       LD   A,(BUFSIZ)       LD   D,#00       LD   E,A       LD   A,L       OR   A       SBC  HL,DE       JR   NC,PGWR02       LD   (BUFSIZ),APGWR02       CALL PUSWPGWR03       LD   A,#FF       LD   (FRDFLG),A       LD   A,(UFFLG)       OR   A       JP   NZ,WECDF2WECDNX       LD   A,(DEPB25)       OR   A       JR   Z,WECNX1WECNX2       XOR  A       LD   C,#26       RST  #10       RET  C       EXX       LD   BC,#000C       ADD  HL,BC       LD   E,(HL)       INC  HL       LD   D,(HL)       LD   C,#21       RST  #10       RET  C       LD   HL,DEPB25       DEC  (HL)       JR   NZ,WECNX2WECNX1       LD   HL,(FDWRI)       LD   DE,#0020       ADD  HL,DE       EX   DE,HL       LD   HL,(FDCUR)       OR   A       SBC  HL,DE       EX   DE,HL       JP   NC,WENX01       LD   C,#33       RST  #10       EXX       LD   (L6020),HL       LD   A,(L62FC)       LD   DE,(L6036)       CALL L637E       RET  C       LD   HL,(FDSTT)       LD   (FDNXT),HL       LD   HL,#0000       LD   (FDCUR),HL       LD   A,(BUFSIZ)       LD   (BUFBLK),A       LD   HL,(LSTBLK)       LD   (FSTBLK),HL       XOR  A       LD   (PGRDR),A       LD   (PGWRI),A       LD   A,#40       LD   (PGFRE),A       LD   A,(CRLVL)       OR   A       JP   Z,RECD4       JP   RECD12RECD10       LD   HL,CRLVL       LD   C,(HL)       INC  HL       LD   B,(HL)       LD   HL,FNLVL       ADD  HL,BC       RETPGWR10       LD   HL,PGWRI       JR   PGRD11PGRD10       LD   HL,PGRDRPGRD11       LD   C,(HL)       INC  HL       LD   B,(HL)       LD   HL,PGLST       ADD  HL,BC       RETBLUMFW       LD   A,(PGWRI)       JR   BLUM01BLUMFR       LD   A,(PGRDR)   ; ниже - подсчёт свободных блоков в расширенной памятиBLUM01       LD   HL,#0000       LD   B,A       LD   A,4       SUB  B       RET  C       LD   B,A       LD   DE,#0040       JR   Z,2$1$       ADD  HL,DE       DJNZ 1$2$       LD   A,(PGFRE)       LD   E,A       ADD  HL,DE       RETFDREAD       PUSH HL       LD   HL,(FDEND)       LD   DE,(FDNXT)       OR   A       SBC  HL,DE       POP  HL       JR   Z,FDRD3       RET  C       LD   (FDCUR),DE       LD   BC,#000C       LDIR             ; в область дескрипторов копируем дескриптор копируемого файла       DEC  DE       EX   DE,HL       LD   A,(L60BE)       BIT  6,(HL)      ; проверяем сегментированный/непрерывный       JR   Z,FDRD1     ; сегментированный - переходим       BIT  2,A         ; проверка ключа /S       JR   Z,FDRD2       RES  6,(HL)       JR   FDRD2FDRD1  BIT  1,A         ; проверка ключа /C       JR   Z,FDRD2       EX   DE,HL       PUSH HL       LD   BC,#0004       ADD  HL,BC       LD   A,(HL)      ; смотрим старший байт длины в дескрипторе       OR   A           ; если не 0-файл непрерывным не делаем       POP  HL       EX   DE,HL       JR   NZ,FDRD2       SET  6,(HL)FDRD2  EX   DE,HL       LD   BC,#0014       INC  DE       LDIR              ; копируем остальные 20 байт дескриптора из кэша       LD   (FDNXT),DE       EX   DE,HL        ; обнуляем байт по смещению +25       LD   DE,#0007       XOR  A       SBC  HL,DE       LD   (HL),A       RETFDRD3  SCF       RETPUSW       XOR  A       LD   (BUFBLK),APUSW03       LD   A,(PGFRE)       LD   B,A       LD   A,#40       SUB  B       LD   D,A       LD   E,#00       LD   HL,#C000       ADD  HL,DE       PUSH HL            ; вычислили адрес откуда копировать       LD   A,(BUFBLK)       LD   D,A       LD   HL,(L64FD)       ADD  HL,DE       PUSH HL            ; адрес куда копировать       LD   C,A       LD   A,(BUFSIZ)       SUB  C       CP   B       JR   NC,PUSW02       LD   B,APUSW02       LD   C,#00       POP  DE       POP  HL       PUSH BC       EXX       CALL PGWR10       LD   A,(HL)       LD   BC,#7FFD       DI       OUT  (C),A       EXX       LDIR       EXX       LD   A,#10       OUT  (C),A       EI       EXX       POP  BC          ; B-количество скопированных блоков       LD   A,(PGFRE)       SUB  B       JR   NZ,PUSW01       LD   HL,PGWRI    ; выбрали всю страницу, переходим на новую       INC  (HL)       LD   A,#40PUSW01       LD   (PGFRE),A       LD   A,(BUFSIZ)       LD   C,A       LD   A,(BUFBLK)       ADD  A,B       LD   (BUFBLK),A       CP   C       JR   C,PUSW03    ; если не весь, идём на следующую итерацию копирования       LD   A,(BUFSIZ)       LD   (BUFBLK),A       RETCRLVL  DEFW #0000        ; уровень вложенности каталогаFNLVL  DEFS 9            ; номера файлов на разных уровнях вложенностиSREDA  DEFS 4            ; сохранённая средаBLKSM  DEFW #0000        ; подсчитанный объём блоков для копированияFDSTT  DEFW #0000        ; начало массива с дескрипторами (L6575)FDCUR  DEFW #0000        ; адрес текущего файлового дескриптора в массивеFDNXT  DEFW #0000        ; адрес следующего дескриптора в массивеFDEND  DEFW #0000        ; адрес начала буфера для копированияFDWRI  DEFW #0000        ; адрес текущего записываемого дескриптораBUFSIZ DEFB #00          ; буфер, используемый для копирования. Например, уменьшаем до 16к (размер банки)BUFBLK DEFB #00          ; количество свободных блоков в буфере памятиFSTBLK DEFW #0000        ; количество прочитанных блоков первого файла в массивеLSTBLK DEFW #0000        ; количество прочитанных блоков последнего файла в массивеFSTBL1 DEFW #0000        ; номер блока, с какого продолжать копировать файл после переключения страницы буфераLSTBL1 DEFW #0000        ; смещение докуда был записан последний файлCURSBL DEFW #0000        ; 0-й блок текущего исходного каталогаCURDBL DEFW #0000        ; 0-й блок текущего приёмного каталогаFSTFLG DEFB #00          ; флаг первого дескриптора в массивеFRDFLG DEFB #00          ; поднимаем этот флаг после переключения страницы буфера. Первый файл.DEPB25 DEFB #00          ; байт 25, показывает, на сколько уровней вернутьсяPGWRI  DEFW #0000PGRDR  DEFW #0000PGLST  DEFB #11,#13,#14,#16,#17,#00PGFRE  DEFB #00BWBLK  DEFB #00UFFLG  DEFB #00PFULG  DEFB #00SVLEN  DEFW #0000