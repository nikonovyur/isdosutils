       .GLOB WECD       .GLOB FNLVL, FDCUR, FDNXT       .GLOB FDWRI, BUFSIZ, BUFBLK, FSTBLK, LSTBLK       .GLOB FSTBL1, LSTBL1, CURSBL, CURDBL, FSTFLG       .GLOB FRDFLG, DEPB25, PGWRI, PGRDR, PGLST, PGFRE       .GLOB BWBLK, UFFLG, PFULG, SVLEN       .GLOB FDSTT, MWINV       .GLOB PGRD10, PGWR10, BLUMFW, BLUMFR, FDREAD       .GLOB PUSW, MRKFLS, CPMMF, FLWOFS, OVPAS, SPSND       .GLOB L6036, L62FD, L6020, L637E, L5DC4, L64FD       .GLOB L64BC, L5DC3, OVPOS, FLPTST, OWINV, LTEFWN       .GLOB FNBUF, OVFLG, OVFLGW, OVPO01, OVPBED, RECD4       .GLOB WRTOFL, L62FC, BLNKWN, L634C, OVEXT       .GLOB DSTWIN, DESTWN, BLKWR, PRBR, PRSW       .GLOB CLOVB; Процедура записиWECD       LD   C,#33       RST  #10       EXX       LD   (L6036),HL       LD   A,(L5DC3)       BIT  3,A       LD   A,#01       CALL Z,DSTWIN       LD   A,(L62FD)       LD   DE,(L6020)       CALL L637E       RET  C       LD   A,(L5DC4)       DEC  A       JP   Z,WENX12       XOR  A       LD   (PGWRI),A       LD   (FRDFLG),A       LD   HL,#0000       LD   (FSTBL1),HL       CALL BLUMFR       LD   A,(BUFBLK)       LD   B,A       LD   A,(BUFSIZ)       SUB  B       JP   Z,WENX12       LD   E,A       LD   D,#00       OR   A       SBC  HL,DE       JP   C,WENX11; ветка, где буфер просто копируется в расширенную память; он туда влезает       LD   A,(BUFBLK)       LD   B,A       LD   A,(BUFSIZ)       SUB  B       LD   (BUFSIZ),A       XOR  A       LD   (BUFBLK),A       CALL PRSW       XOR  A       LD   (PGWRI),A       LD   A,#40       LD   (PGFRE),A       LD   A,(L64BC)       LD   (BUFSIZ),A       XOR  A       CALL PUSW       XOR  A       LD   (PFULG),A       JR   WENX12WENX11; ветка, где происходит обмен блоками с расширеной памятью; на размер буфера       LD   A,#40       LD   (PGFRE),A       CALL PUSW       LD   A,#FF       LD   (PFULG),AWENX12       LD   A,(BUFSIZ)       LD   (BUFBLK),A       LD   HL,(FDSTT)WENX01       LD   (FDWRI),HL       PUSH HL       LD   BC,#0019       ADD  HL,BC       LD   A,(HL)       LD   (DEPB25),A       LD   (HL),#00       POP  HL       LD   BC,#000B       ADD  HL,BC       BIT  5,(HL)       JP   Z,WECDFL; дескриптор каталога       LD   HL,(FDWRI)       LD   C,#25       RST  #10       JP   NC,WECD01       CP   #51       SCF       RET  NZ       LD   HL,(FDWRI)       PUSH HL       LD   BC,#000C       PUSH BC       ADD  HL,BC       XOR  A       LD   (HL),A       INC  HL       LD   (HL),A       LD   BC,#0004       ADD  HL,BC       LD   D,H       LD   E,L       INC  DE       POP  BC       LD   (HL),A       LDIR       POP  HL; Процедура создания, HL - адрес дескриптора;MKDIR       PUSH HL       POP  IX       PUSH HL           ; если каталог непрерывный       LD   BC,#000B       ADD  HL,BC       BIT  6,(HL)       JR   Z,1$       INC  (IX+#0F)     ; добавляем ещё 1 блок1$       POP  HL       LD   C,#23        ; Создаём каталог       RST  #10       RET  C       EXX       LD   BC,#000B       ADD  HL,BC       LD   A,(HL)       ; A - регистр состояния       LD   C,#6       ADD  HL,BC       LD   E,(HL)       INC  HL       LD   D,(HL)       ; DE - номер блока описателя сегментов       AND  #40          ; Проверка 6-го бита непрерывный ли файл?       JR   NZ,MKD01     ; каталог непрерывный - переходим       RST  #10          ; блок номер DE считываем в кэш       RET  C       EXX       INC  HL       LD   E,(HL)       INC  HL       LD   D,(HL)       PUSH DE       EXX       POP  DEMKD01  INC  HL       LD   (HL),E       INC  HL       LD   (HL),D       LD   C,#28       RST  #10       RET  C       PUSH DE       LD   BC,#FFEC       ADD  HL,BC       LD   BC,#0020       PUSH IX       POP  DE       LDIR             ; копируем в локальный дескриптор внутренний дескриптор с обновлёнными данными       LD   C,#10       ; далее заполняем дескриптор дефолтным содержимым (1 элемент каталога и т.д. )       ADD  HL,BC       LD   A,(HL)       INC  HL       INC  HL       INC  HL       LD   E,(HL)       INC  HL       LD   D,(HL)       INC  HL       INC  HL       INC  HL       OR   (HL)       INC  A       LD   (IX+#0C),E       LD   (IX+#0D),D       LD   (IX+#17),A       LD   (IX+#15),#01       POP  DE       LD   C,#6        ; считываем первый блок каталога       RST  #10       RET  C       EXX       PUSH DE       EX   DE,HL       PUSH IX       POP  HL       LD   BC,#0020       LDIR             ; заполняем первый элемент каталога своим же дескриптором       LD   C,#DF       LD   L,E       LD   H,D       INC  DE       LD   (HL),#0       LDIR             ; остальная часть блока - нули       POP  DE       LD   C,#2E       ; помечаем блок в кэше как модифицированный       RST  #10       RET  C; В регистре A - вычисляем количество блоков, подлежащих забивке нулями       LD   L,(IX+#0E)       LD   H,(IX+#0F)       LD   A,L       OR   A       LD   A,H       JR   NZ,MKD02       DEC  AMKD02  OR   A       JR   Z,MKD05       LD   B,A       LD   DE,#0001; цикл забивки нулями блоков каталога, следующих за первымMKD03  LD   C,#2D      ; читаем блок в кэш       RST  #10       RET  C       EXX             ; получаем в HL' адрес блока в кэше       XOR  A       LD   B,AMKD04  LD   (HL),A     ; пишем в блок нули       INC  HL       DJNZ MKD04       PUSH DE       EXX       POP  HL       EX   DE,HL       LD   C,#2E      ; помечаем блок в кэше как модифицированный       RST  #10       RET  C       EX   DE,HL       INC  DE       DJNZ MKD03MKD05       LD   C,#2       RST  #10       RET  C       LD   IX,MWINV       CALL WRTOFL       LD   HL,(FDWRI)       LD   BC,#0013       ADD  HL,BC       LD   E,(HL)       INC  HL       LD   D,(HL)       LD   C,#21       RST  #10       RET  C       JP   WECDNXWECD01       OR   A       SCF       RET  Z       JP   WECDNX; дескриптор файлаWECDFL       LD   IX,(FDWRI)       XOR  A       LD   (IX+#11),A       LD   (IX+#12),A       PUSH IX       POP  HL       LD   C,#25       RST  #10       JP   C,WECDF1       CALL FLWOFS       XOR  A       OR   D       OR   E       JP   NZ,WECDF2; наткнулись на существующий файл, решаем что делать дальше       LD   A,(L5DC3)       BIT  1,A       JR   NZ,1$       RRCA       JP   C,OVWRI       JP   OVPSS1$       RRCA       LD   A,#01       JR   C,3$       LD   A,#023$       LD   (OVPOS),A       CALL FLPTST       RET  C       LD   IX,OWINV       PUSH IX       LD   A,#01       LD   C,#61       RST  #10       LD   IX,LTEFWN       LD   A,#FF       LD   C,#61       RST  #10       POP  IX       LD   C,#66       RST  #10       LD   HL,#0202       LD   (OVNFCR),HL       LD   HL,FNBUF       LD   (OVNFAD),HL       LD   B,3OVNFPR       PUSH BC       LD   HL,(OVNFCR)       LD   C,#6B       RST  #10       INC  H       LD   (OVNFCR),HL       LD   HL,(OVNFAD)       LD   B,23       LD   C,#6D       RST  #10       LD   BC,23       ADD  HL,BC       LD   (OVNFAD),HL       POP  BC       DJNZ OVNFPR       LD   A,(OVPOS)       CALL OVPBUTOVKIN       LD   C,#08       RST  #10       DEC  C       RST  #10       CP   #10       JP   Z,OVEXT       CP   "a"       JR   Z,TOGFLG       CP   "A"       JR   Z,TOGFLG       CP   #09        ; стрелка вправо       JR   Z,OVRGT       CP   #08        ; стрелка влево       JR   Z,OVLFT       CP   #0D       JP   Z,OVEND       JR   OVKINOVNFCR       DEFW #0202OVNFAD       DEFW FNBUFTOGFLG       LD   IX,OWINV       LD   HL,#0603       LD   C,#6B       RST  #10       LD   HL,OVFLG       LD   A,#01       XOR  (HL)       LD   (HL),A       LD   A,#20       JR   Z,TOGF01       LD   A,#FBTOGF01       LD   (OVFLGW),A       LD   C,#0A       RST  #10       JR   OVKINOVRGT       LD   A,(OVPOS)       CP   #03       JR   NC,OVKIN       OR   #80       CALL OVPBUT       AND  #03       INC  A       LD   (OVPOS),A       CALL OVPBUT       JR   OVKINOVLFT       LD   A,(OVPOS)       CP   #02       JP   C,OVKIN       OR   #80       CALL OVPBUT       AND  #03       DEC  A       LD   (OVPOS),A       CALL OVPBUT       JP   OVKIN; подпрограма рисования и стирания подсвеченных кнопок; A-биты 0-1 - номер кнопки (1-3), бит 7 поднят - кнопку стираем; бит 7 сброшен - подсвечиваем. Регистр A сохраняетсяOVPBUT       LD   IX,OVPO01       LD   HL,OVPBED       LD   B,A       RES  7,B       PUSH AFOVPB01       DEC  HL       DEC  HL       DJNZ OVPB01       AND  #80       LD   A,(CLOVB)    ; цвет подсветки кнопок, заменить на цвет из UnCo       JR   Z,OVPB02       LD   A,(OWINV+#04)OVPB02       LD   (IX+#04),A       LD   A,(HL)       LD   (IX+#03),A       INC  HL       LD   A,(HL)       LD   (IX+#00),A       LD   A,#FF       LD   C,#61       RST  #10       POP  AF       RETOVEND       LD   A,(OVFLG)       LD   HL,L5DC3       OR   A       LD   A,(OVPOS)       JR   Z,1$       RES  1,(HL)       CP   #01       JR   NZ,4$       SET  0,(HL)       JR   2$4$       CP   #02       JR   NZ,2$       RES  0,(HL)       JR   2$1$       SET  1,(HL)2$       CP   #03       JR   NZ,OVE01OVEXT       LD   A,(L62FC)       LD   DE,(L6036)       CALL L637E       LD   SP,(SPSND)       JP   RECD4OVE01       LD   IX,OWINV       CALL BLNKWN       LD   A,(OVPOS)       CP   #02       JR   Z,OVPSSOVWRI       XOR  A       LD   (OVPAS),A       LD   C,#3C       RST  #10       RET  C       JR   WCDF14OVPSS       LD   A,#01       LD   (OVPAS),A       JR   WECDF2WECDF1       CP   #51       SCF       RET  NZWCDF14       LD   HL,(FDWRI)       PUSH HL       LD   BC,#000B       ADD  HL,BC       XOR  A       LD   D,#00       BIT  6,(HL)      ; если файл непрерывный, манипуляции с добавлением блоков не делаем       JR   NZ,WCDF13       LD   BC,#0004       ADD  HL,BC       LD   E,(HL)       LD   A,(HL)       LD   (SVLEN),A       RES  7,(HL)       INC  HL       LD   D,(HL)       LD   A,(HL)       LD   (SVLEN+1),A       LD   (HL),#00       LD   A,E       AND  #80WCDF13       OR   D       POP  HL       PUSH AF       LD   C,#3B       RST  #10       POP  BC       RET  C       PUSH BC       POP  AF       JR   Z,WCDF11       RLCA       RLCA       LD   B,AWCDF12       LD   DE,#4000       LD   C,#31       RST  #10       RET  C       DJNZ WCDF12       LD   HL,(FDWRI)       LD   BC,#000F       ADD  HL,BC       LD   A,(SVLEN)       LD   (HL),A       INC  HL       LD   A,(SVLEN+1)       LD   (HL),AWCDF11       LD   C,#02       RST  #10       RET  CWECDF2       LD   HL,(FDWRI)       PUSH HL       LD   A,(BUFBLK)       LD   B,A       LD   A,(BUFSIZ)       SUB  B       LD   D,A       XOR  A       LD   E,A       LD   HL,(L64FD)       ADD  HL,DE       ; вычисляем адрес откуда считывать       EX   DE,HL       POP  HL       PUSH HL       PUSH DE       CALL L634C       ; вычисляем размер в блоках текущего открытого файла       PUSH HL          ; запоминаем в стеке       CALL FLWOFS      ; вычисляем смещение записи в DE       POP  HL       OR   A       SBC  HL,DE       PUSH DE       LD   A,H       OR   A       JR   NZ,WECF02   ; переход, если остаток блоков больше 255       LD   A,(BUFBLK)       CP   L       JR   C,WECF02       LD   B,L         ; ветка, где остаток буфера больше остатка файла       SUB  B       LD   (BUFBLK),A  ; после расчёта количества считываемых блоков вычисляем остаток буфера       LD   HL,#0000       LD   (LSTBL1),HL       XOR  A       LD   (UFFLG),A       JR   WECF03WECF02       EX   DE,HL       LD   A,(BUFBLK)       LD   B,A       LD   D,#00       LD   E,A       ADD  HL,DE       LD   (LSTBL1),HL       LD   A,#FF       LD   (UFFLG),A       XOR  A       LD   (BUFBLK),A  ; обнуляем остаток буфераWECF03       XOR  A       LD   D,A       LD   E,B       LD   HL,(BLKWR)       ADD  HL,DE       LD   (BLKWR),HL       POP  DE       POP  HL       LD   A,(OVPAS)       OR   A       JR   NZ,1$       LD   C,#2C       RST  #101$       POP  HL           ; вспоминаем адрес дескриптора       RET  C       LD   IX,MWINV       XOR  A       OR   D       OR   E       CALL Z,WRTOFL       CALL PRBR; если включен буфер, грузим данные из буфера       LD   A,(L5DC4)       DEC  A       JR   Z,WECDNX       XOR  A       LD   (FRDFLG),A       LD   HL,(LSTBL1)       LD   (FSTBL1),HL       LD   A,(BUFBLK)       OR   A       JR   NZ,WECDNX       CALL PGWR10       LD   A,(HL)       OR   A       JR   NZ,PGWR01       LD   A,(L64BC)       LD   (BUFSIZ),A       LD   A,(PFULG)       OR   A       JR   Z,WECDNX       XOR  A       LD   (PGWRI),A       LD   A,#40       LD   (PGFRE),A       CALL PUSW       XOR  A       LD   (PFULG),A       LD   A,#05       LD   (PGWRI),A       JR   PGWR03PGWR01       CALL BLUMFW       LD   A,(BUFSIZ)       LD   D,#00       LD   E,A       LD   A,L       OR   A       SBC  HL,DE       JR   NC,PGWR02       LD   (BUFSIZ),APGWR02       CALL PUSWPGWR03       LD   A,#FF       LD   (FRDFLG),A       LD   A,(UFFLG)       OR   A       JP   NZ,WECDF2; смотрим не надо ли выходить из каталога; и переходим к следующему файлуWECDNX       LD   A,(DEPB25)       OR   A       JR   Z,WECNX1WECNX2       XOR  A       LD   C,#26       RST  #10       RET  C       EXX       LD   BC,#000C       ADD  HL,BC       LD   E,(HL)       INC  HL       LD   D,(HL)       LD   C,#21       RST  #10       RET  C       LD   HL,DEPB25       DEC  (HL)       JR   NZ,WECNX2WECNX1       LD   HL,(FDWRI)       LD   DE,#0020       ADD  HL,DE       EX   DE,HL       LD   HL,(FDCUR)       OR   A       SBC  HL,DE       EX   DE,HL       JP   NC,WENX01       LD   C,#33       RST  #10       EXX       LD   (L6020),HL; усли надо, выводим окно "вставьте диск источник"       LD   A,(L5DC3)       BIT  3,A       LD   A,#00       CALL Z,DSTWIN       LD   A,(L62FC)       LD   DE,(L6036)       CALL L637E       RET  C       LD   HL,(FDSTT)       LD   (FDNXT),HL       LD   HL,#0000       LD   (FDCUR),HL       LD   A,(BUFSIZ)       LD   (BUFBLK),A       LD   HL,(LSTBLK)       LD   (FSTBLK),HL       LD   A,(OVPAS)       OR   H       OR   L       LD   A,#00       JR   NZ,1$       LD   (OVPAS),A1$       LD   (PGRDR),A       LD   (PGWRI),A       LD   A,#40       LD   (PGFRE),A       RET