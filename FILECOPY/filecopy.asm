       ORG  #5DC0       .GLOB L6575, LTSWN, CPDFLG       .GLOB L5DC5, FDSTT, FDNXT, FDEND, L64FD, L635E, L636E, L6023, L62FD, L6020, L5F53       .GLOB L62FC, L6036, L60BE, MWTXT, MVTTLP, MVTXTW, L60DD, SREDA, RECD10, CRLVL, L634C, BLKSM       .GLOB L6555, L64BC, L5DC4, L5FA1, L5DC3, L653D       .GLOB MVMNBT, MVTX2W, LTSWCL, L6015, MVBIND, L5FAC, L5DD8       .GLOB WECD       .GLOB FNLVL, FDCUR       .GLOB FDWRI, BUFSIZ, BUFBLK, FSTBLK, LSTBLK       .GLOB FSTBL1, LSTBL1, CURSBL, CURDBL, FSTFLG       .GLOB FRDFLG, DEPB25, PGWRI, PGRDR, PGLST, PGFRE       .GLOB BWBLK, UFFLG, PFULG, SVLEN       .GLOB PGRD10, PGWR10, BLUMFW, BLUMFR, FDREAD       .GLOB PUSW, MRKFLS, CPMMF, FLWOFS, OVPAS, SPSND       .GLOB L637E, MWINV, WRFRFL, WRTOFL, OVPOS, FLPTST, OWINV       .GLOB LTEFWN, FNBUF, OVFLG, OVFLGW, OVPO01, OVPBED       .GLOB RECD4, BLNKWN       .GLOB RECD, MVFRPT, MVTOPT       .GLOB DSTWIN, DESTWN, DEMD, MVPRBR       .GLOB L60B0, L5FE0, L5FE6       .GLOB CLMWN, CLMWE, CLMNW, CLMWC, CLOVW, CLOVF, CLOVB       .GLOB CLDSR, CLDDS, CLSHD, CLCLR, CLERW       .GLOB ADMWN, ADOVW, ADOVF, ADERW, ADER1, ADCLW	JP   L6575L5DC3	DEFB	#03L5DC4  DEFB #0B         ; использование буфера для копированияL5DC5  DEFB #20         ; максимальное количество файлов за 1 заходL5DC6	DEFB	#0CL5DC7  DEFB #3E       DEFB #FFL5DC9  DEFW #7FFDL5DCB  DEFB #C0L5DCC  DEFB #10L5DCD  DEFB #C7; Страницы памяти буфера 80кбL5DCE  DEFB #11L5DCF  DEFB #13L5DD0  DEFB #14L5DD1  DEFB #16L5DD2  DEFB #17       DEFM "UnCo"       DEFB #0CCLMWN  DEFB #38         ; цвет главного окнаCLMNW  DEFB #20         ; цвет окна менюCLOVW  DEFB #30         ; цвет окна "файл существует"CLDSR  DEFB #20         ; цвет окна "диск источник"CLDDS  DEFB #30         ; цвет окна "диск приёмник"CLMWE  DEFB #28         ; цвет области ввода путиCLMWC  DEFB #04         ; цвет курсора менюCLOVF  DEFB #0F         ; область файла в окне "файл существует"CLERW  DEFB #90         ; цвет окон с ошибкамиCLOVB  DEFB #28         ; цвет подсвеченной кнопки окна "файл существует"CLSHD  DEFB #01         ; цвет тениCLCLR  DEFB #00         ; цвет затираемого окнаL5EE1  DEFB #07	DEFB	#14	DEFB	#03       DEFB #13ADERW  DEFB #90	DEFB	#FF       DEFB #0B       DEFB #16       DEFM "Целевой путь не найден"       DEFB #03L5EF0  DEFB #0A	DEFB	#14	DEFB	#03       DEFB #0DADER1  DEFB #90	DEFB	#FF       DEFB #0F       DEFB #0E       DEFM "Не iS-DOS диск"       DEFB #03;этим окном затираются окна с ошибками внизу экранаL5F09  DEFB #04	DEFB	#12	DEFB	#05	DEFB	#18ADCLW  DEFB #03	DEFB	#FF	DEFB	#08	DEFB	#1B; окно "перезапись файла"OWINV        DEFB 5        DEFB 12        DEFB 11        DEFB 22ADOVW   DEFB %00110000        DEFB %00000001        DEFB 8        DEFB 27OVTXT        DEFM "╔════ Файл существует ════╗"        DEFM "║                         ║"        DEFM "║                         ║"        DEFM "║                         ║"        DEFM "╟─────────────────────────╢"        DEFM "║ [√] Примен. ко всем [A] ║"        DEFM "╟─────────────────────────╢"        DEFM "║ [Замена] [Проп] [Выход] ║"        DEFM "╚═════════════════════════╝"        DEFB #03OVFLGW  EQU  OVTXT + 138; закрашенная о,ласть с путём и именм файлаLTEFWN        DEFB 7        DEFB 14        DEFB 3        DEFB 18ADOVF   DEFB %00001111        DEFB #FF        DEFB 10        DEFB 23OVFLG        DEFB #01OVPOS        DEFB #01OVPO01        DEFB 7        DEFB 20        DEFB 1        DEFB 7        DEFB %00101000        DEFB #FF        DEFB 10        DEFB 8OVPBTL        DEFW #1306        DEFW #0E05        DEFW #0707OVPBEDL5F53                    ; путь куда копировать       DEFS 55	DEFB	#20	DEFB	#20	DEFB	#20	DEFB	#20	DEFB	#20	DEFB	#20	DEFB	#20	DEFB	#20	DEFB	#20	DEFB	#20	DEFB	#20	DEFB	#0D; буфер для формирования надписейFNBUF       DEFS 69; главное окноMWINV       DEFB 1       DEFB 6       DEFB 9       DEFB 30ADMWN  DEFB %00111000       DEFB %00000001       DEFB 3       DEFB 37MWTXT       DEFM "╔═══════════ Копирование ═══════════╗"       DEFM "║ Копирование                       ║"       DEFM "║                                   ║"       DEFM "║                                   ║"       DEFM "╟───────────────────────────────────╢"       DEFM "║      [Enter] [SS/SP] [SS/A]       ║"       DEFM "╚═══════════════════════════════════╝"       DEFB #03MVTTLP EQU  MWTXT + 12MVTXTW EQU  MWTXT + 39MVTX2W EQU  MWTXT + 76MVBIND EQU  MWTXT + 30MVMNBT EQU  MWTXT + 200MVFRPT EQU  MWTXT + 42MVTOPT EQU  MWTXT + 79MVPRBR EQU  MWTXT + 118L5FA1       LD   IX,MWINV       LD   A,#01       LD   C,#61       ; выводим главное окно       RST  #10       LD   C,#66       ; текст главного окна       RST  #10       LD   IX,LTSWN       LD   A,#FF       LD   C,#61       ; красим область редактирования       RST  #10       LD   HL,#0000       LD   C,#6B       RST  #10       LD   HL,L5F53       LD   A,#0       ; если здесь не 0 - редактор не выводитсяL5FAC	EQU	$-#1	OR   A	JR   NZ,L5FBF	LD   A,#21       LD   DE,#0B00       LD   BC,#026E	RST  #10	PUSH AF       CALL L5FC4	POP  AF       RETL5FBF	LD   C,#67	RST  #10	XOR  A       RETL5FC4	LD   A,#0L5FC5	EQU	$-#1	AND  A	RET  Z	LD   IX,L5F09       LD   A,(CLCLR)	LD   (IX+#4),A	XOR  A	LD   (L5FC5),A	INC  A	LD   C,#61	RST  #10       RETL5FE0  LD   IX,L5EF0       JR   L5FEAL5FE6  LD   IX,L5EE1L5FEA  LD   A,#55       LD   (L5FC5),AL5FF5  XOR  A       LD   C,#61       RST  #10       LD   C,#66       RST  #10       RETL6015       LD   A,(L62FC)       LD   DE,(L6036)       CALL L637E        ; открыть диск и каталог источника       RET  C       LD   A,(L5DC4)       DEC  A       LD   A,(L64BC)       JR   Z,1$       LD   A,#40       LD   (PGFRE),A       XOR  A       LD   (FRDFLG),A       LD   A,(L64FD+1)       LD   B,A       LD   A,#C0       SUB  B       LD   B,A       LD   A,(L64FD)       OR   A       JR   Z,2$       DEC  B2$       LD   A,(L64BC)       CP   B       JR   C,1$       LD   A,B       LD   (L64BC),A1$       LD   (BUFSIZ),A       LD   (BUFBLK),A   ; инициализируем количество свободных блоков размером буфера       LD   A,(CPDFLG)       CP   #02       JP   Z,COPMRK     ; копируем отмеченные файлы       OR   A       JP   Z,COPFIL       CP   #01       JP   Z,COPFIL     ; копируем файл под курсоромL6343  LD   DE,(L60DD)       LD   C,#27       RST  #10       RET  C       EXXL634C  PUSH HL       EXX	POP  IX	LD   L,(IX+#F)	LD   H,(IX+#10)	LD   A,(IX+#E)	OR   A	RET  Z	INC  HL       RET; L60DD - номер файла в каталоге; возвращает в HL-адрес байта состояния отметки файлаL635E  LD   DE,(L60DD)L6362  LD   C,#86       RST  #10       EXX       PUSH HL       EXX       POP  HL       RETL637E  LD   B,A       LD   C,#1C        ; переключить блочное устройство	RST  #10	RET  C	LD   A,(L5DC3)	BIT  3,A	JR   NZ,L638E       LD   C,#F         ; диск тотже - автонастройка диска	RST  #10	RET  CL638E  LD   C,#21        ; открыть каталог	RST  #10	RET  C;       XOR  A;       LD   (L6122),A	LD   HL,L6575	LD   (L60B0),HL       RETL653D  LD   HL,L5F53	LD   C,#4B       RST  #10         ; открываем устройство по пути из буфера	JR   NC,L655E       CP   #51         ; нет такого каталога	JR   Z,L6552       CP   #9          ; не iSDOS устройство       SCF	RET  NZ       CALL L5FE0       ; печать "Not iS-DOS"	JR   L6555L6552  CALL L5FE6       ; печать "No path"L6555  LD   A,(L5DC6)   ; восстанавливаем кэш и выходим	LD   C,#0	RST  #10	XOR  A	INC  A       RETL655E  JR   NZ,L6552    ; PRO_81       EXX              ; имя выходного файла       LD   C,#33       RST  #10       LD   (L62FD),A   ; текущий диск       EXX       LD   (L6020),HL  ; текущий каталог	XOR  A       RETCOPMRK       LD   A,(L636E)       LD   B,A1$       LD   E,B       LD   C,#86       RST  #10       EXX       DEC  HL       LD   A,(HL)       EXX       LD   HL,CPMMF       CP   (HL)       JR   NZ,2$       LD   A,B       LD   C,#26       RST  #10       RET  C       EXX       PUSH HL       CALL FDREAD       POP  HL       JP   C,RECD4       PUSH HL       DEC  HL       LD   A,(HL)       ; получаем номер текущего каталога в каталоге уровнем выше       CALL RECD10       LD   (HL),A       ; запоминаем номер в мвссиве       LD   IX,MWINV       CALL WRFRFL       POP  HL       CALL RECD       RET  C       JR   3$2$       DJNZ 1$3$       LD   HL,CPMMF       INC  (HL)       LD   A,(MRKFLS)       CP   (HL)       JR   NC,COPMRK       CALL WECD       RET  C       JP   RECD4COPFIL       LD   A,(L60DD)       LD   C,#26       RST  #10       RET  C       EXX       PUSH HL       CALL FDREAD       POP  HL       JP   C,RECD4       LD   A,(CPDFLG)       OR   A       JR   Z,RECD11       PUSH HL       DEC  HL       LD   A,(HL)       ; получаем номер текущего каталога в каталоге уровнем выше       CALL RECD10       LD   (HL),A       ; запоминаем номер в мвссиве       LD   IX,MWINV       CALL WRFRFL       POP  HL       CALL RECD       RET  C       CALL WECD       RET  C       JP   RECD4; копирование каталога с подкаталогамиCOPDIRRECD11       PUSH HL       DEC  HL       LD   A,(HL)       ; получаем номер текущего каталога в каталоге уровнем выше       CALL RECD10       LD   (HL),A       ; запоминаем номер в мвссиве       LD   IX,MWINV       CALL WRFRFL       POP  HL       LD   BC,#0013     ; номер 0-го блока каталога по смещению 19       ADD  HL,BC       LD   E,(HL)       INC  HL       LD   D,(HL)       LD   C,#21       RST  #10       RET  C       LD   HL,CRLVL       INC  (HL)RECD12                   ; заходим сюда из процедуры записи       CALL RECD10RECD1       LD   A,(HL)       LD   C,#26       RST  #10       JP   NC,RECD3       CP   #50          ; проверяем на ошибку 80 (выход за список каталога)       SCF       RET  NZ; ветка возвращения на уровень выше и удаления каталога из которого вышли       XOR  A            ; перебрали все файлы в каталоге, возвращаемся на уровень выше       LD   C,#26       RST  #10       RET  C       EXX       LD   BC,#000C       ADD  HL,BC       LD   E,(HL)       INC  HL       LD   D,(HL)       LD   C,#21       RST  #10       RET  C       LD   HL,(FDCUR)       LD   DE,#0019       OR   A       ADC  HL,DE       INC  (HL)       CALL RECD10       LD   (HL),#00       LD   HL,CRLVL       DEC  (HL)       LD   A,(L60BE)       AND  #01       CALL NZ,DEMD       RET  C       LD   HL,CRLVL       XOR  A       OR   (HL)       JR   NZ,RECD2; обошли все файлы, финальная запись       CALL WECD       RET  C       JR   RECD4RECD3       OR   A       JR   Z,RECD2     ; открыли файл с номером 0, это текущий каталог; здесь открыт файл и с ним можно проводить действия; HL'-адрес системного дескриптора открытого файла       EXX       PUSH HL       LD   BC,#000B       ADD  HL,BC       LD   A,(HL)       POP  HL       BIT  0,A         ; файл не удалён?       JR   Z,RECD2     ; файл/каталог удалён, пропускаем; здесь должно быть копирование дескриптора файла/каталога в массив; сохранить A и HL       PUSH HL       LD   B,A       PUSH BC       CALL FDREAD       POP  BC       LD   A,B       POP  HL       JR   NC,1$       CALL WECD        ; достигнут предел количества считанных дескрипторов (32) - переход на запись       RET  C       JR   RECD121$       BIT  5,A         ; проверяем-открытый файл каталог?       JP   NZ,RECD11       CALL RECD       RET  CRECD2                 CALL RECD10       INC  (HL)       JP   RECD1; выход из программыRECD4       LD   C,#10       RST  #10       EXX       LD   BC,#FFFA       ADD  HL,BC       LD   A,(HL)       LD   C,#00       RST  #10       RET  C       XOR  A       LD   A,#F6       RET