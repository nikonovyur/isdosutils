	ORG  #5DC0	JR   L5E1D       DEFM "UnCo"	DEFB	#07L5DCA	DEFB	#02	DEFB	#01L5DCC	DEFB	#28	DEFB	#05L5DCE	DEFB	#20L5DCF	DEFB	#06L5DD0	DEFB	#10L5DD1  EXX	LD   A,(HL)       INC  A            ; Проверяем на #FF - признак каталога       JR   NZ,L5DFD     ; Переход, если имя файла	LD   C,#35       RST  #10          ; Получаем в HL' адрес системного описателя файла и каталога       EXX       LD   BC,#0020       ADD  HL,BC        ; Перескакиваем на дескриптор удаляемого каталога	LD   DE,L6085       LDIR              ; Копируем дескриптор по адресу сразу за программой       LD   DE,(L6091)   ; начальный блок родительского от удаляемого каталога       LD   C,#21        ; открыть родительский каталог	RST  #10	RET  C       LD   HL,L6085     ; 11 байт имя файла       LD   C,#34        ; открыть файл по имени в HL. Выход HL' - системный описатель каталога	RST  #10	RET  C       LD   C,#35        ; вернуть в HL' адрес системного описателя открытого файла (каталога)	RST  #10       EXX       LD   BC,#000B       ADD  HL,BC        ; установить HL на FSTAT регистр состояния каталога	JP   L5EE4L5DFD  LD   C,#34        ; открыть файл рл имени в HL	RST  #10       JR   NC,L5E0E     ; переход на удаление, если файл открылся       CP   #51          ; ошибка. Проверяем на "файл не найден"       SCF               ; установить флаг C	RET  NZ	LD   HL,L604B	INC  (HL)       DEC  (HL)         ; проверяем на #00 ключ       JR   NZ,L5E16     ; переход, если есть ключ       RETL5E0E  LD   C,#3C        ; удаляем открытый файл	RST  #10	RET  C       LD   C,#2         ; сброс на устройство блоков кэша	RST  #10	RET  CL5E16  LD   C,#41        ; восстановление среды	RST  #10	XOR  A	LD   A,#F4       RET               ; выход в системуL5E1D  LD   C,#43        ; Проверяем на командную строку	RST  #10       JR   NZ,L5E2A     ; Переход, если интерактивный режим	OR   A       JR   Z,L5DD1      ; Переход, если параметр - имя файла       LD   (L604B),A    ; Сохраняем ключ, переходим	JR   L5E1D; интерактивный режимL5E2A  LD   (L6055),SP   ; сохраняем SP, чтобы восстановить перед выходом       LD   C,#87        ; запрос состояния рабочей панели	RST  #10       LD   (L6023),A    ; A - количество отмеченных файлов	PUSH AF       EXX       LD   (L5F8C),HL   ; L,H - минимальный и максимальный номера файлов       DEC  BC           ; BC - адрес вектора оболочки       LD   A,(BC)       ; Номер панели 0-левая, 1-правая       AND  A            ; проверка на 0	JR   Z,L5E5B       LD   A,#12        ; конфигурируем координаты окон	LD   (L5FF4),A	LD   (L5FBE),A	LD   (L5FA8),A	LD   (L5FA0),A	LD   A,#1A	LD   (L5FFA),A	LD   (L5FA6),A	DEC  A	LD   (L5FC4),A	LD   (L5FAE),AL5E5B	POP  AF       AND  A            ; проверка на 0 количество отмеченных файлов       JR   NZ,L5E77     ; переход, если есть отмеченные файлы       LD   A,(L604B)    ; должен быть 0	OR   A	RET  NZ       LD   C,#8A        ; получаем параметры панельного курсора	RST  #10       OR   A            ; A - номер файла       RET  Z            ; Выход, если курсор стоит на точкахL5E69  LD   C,#26        ; открыть файл по номеру в регистре A       RST  #10          ; HL'-адрес системного 32-байтового описателя файла       CALL L5E82        ; рисуем нижнее окно с именем файла	LD   A,#1	LD   (L6023),AL5E74	JP   L6022L5E77	CP   #1       JR   NZ,L5E74     ; переход, если отмечено больше одного файла       CALL L5F73        ; получаем номер файла в каталоге для удаления	RET  C	LD   A,E	JR   L5E69; Процедура рисования нижнего окна с именем файлаL5E82  EXX       PUSH HL          ; копируем имя и расширение в текст, выводимый в окне	LD   DE,L5F94       LD   BC,#0008       LDIR	LD   A,#20	LD   (DE),A	INC  DE	LD   C,#3       LDIR       LD   (L5ED9),HL  ; адрес байта FSTAT в системном дескрипторе	LD   IX,L5FA0	LD   A,(L5DCE)       LD   (IX+#4),A   ; задаём цвет нижнего окна #20	LD   C,#61	XOR  A       RST  #10         ; рисуем окно	LD   HL,L5F94       LD   C,#67       ; выводим текст	RST  #10       POP  HL          ; вспоминаем адрес дескриптора в системе       RETL5EAD	CALL L5F64L5EB0  LD   A,(IX-#9)   ; A-позиция курсора	DEC  A	DEC  A	LD   (L5ED1),A       LD   A,(L6023)   ; обычно там #01	DEC  A       JR   Z,L5ED0	LD   A,#1; главный цикл, где перебираем файлы, помеченные для удаленияL5EC0  LD   (L5F12),A    ; увеличиваем на 1 переменную       CALL L5F73        ; получаем в A номер файла в каталоге для удаления       JR   C,L5F16      ; если файлов не отмечено, или отмеченные файлы закончились, то на выход	LD   A,E	LD   C,#26	RST  #10	RET  C	CALL L5E82L5ED0  LD   A,#0         ; позиция курсора -2 в менюL5ED1	EQU	$-#1       RRA       CALL NC,L6063     ; перерисовка окна с текстом и ожидание нажатий клавиш       JR   NC,L5F11     ; перескок, если файл удалять не надо	LD   HL,0L5ED9	EQU	$-#2	LD   A,(HL)       CPL	AND  #20	LD   (L6058),A	JR   NZ,L5F07L5EE4  LD   DE,0         ; читаем блок #0000 открытого файла (каталога) в кэш	LD   C,#2D       RST  #10          ; HL' - адрес блока в кэше, DE - адрес заголовка блока	RET  C       EXX	PUSH HL       LD   BC,#000B	ADD  HL,BC       ADD  HL,BC       LD   A,(HL)       ; читаем число файлов без каталога и удалённых       POP  HL           ; восстанавливаем HL - указывает на начало дескриптора самого себя в 0-м блоке каталога       OR   A            ; проверяем количество файлов на 0       JR   NZ,L5F47     ; файлов в каталоге не 0 - переходим	ADD  HL,BC       RES  0,(HL)       ; помечаем каталог в 0-м блоке, как удалённый       EXX       RES  5,(HL)       ; сбрасываем 5-й бит в системном дескрипторе. Теперь он файл.       LD   BC,#0005	ADD  HL,BC       LD   (HL),B       ; обнуляем старший байт размера каталога (файла)       EXX       LD   C,#2E        ; DE - адрес описателя блока в кэше - помечаем блок как модифицированный	RST  #10	RET  CL5F07  LD   C,#3C        ; удаление открытого файла	RST  #10	JR   C,L5F2E       LD   A,#F2       LD   (L605D),A    ; записываем код выходаL5F11  LD   A,#1         ; ? - количество удаляемых файловL5F12	EQU	$-#1	INC  A	JR   L5EC0L5F16  LD   C,#2         ; сохраняем кэш и на выход	RST  #10	RET  CL5F1A	OR   #FF       RETL5F1D	LD   IX,L5FBE	LD   A,(L5DD0)	LD   (IX+#4),A	XOR  A	LD   C,#61	RST  #10	LD   C,#66       RETL5F2E	CP   #59       SCF	RET  NZ	CALL L5F1D	RST  #10	CALL L6063	PUSH AF       CALL L5F5C        ; рисование основного окна с текстом	POP  AF	JR   NC,L5F11	LD   HL,(L5ED9)	RES  7,(HL)       JR   L5F07        ; переход на процедуру удаленияL5F47	CALL L5F1D	LD   HL,L5FD4	INC  C	RST  #10	CALL L5F54	JR   L5F1AL5F54	CALL L5F8E	CP   #10	JP   Z,L6054L5F5C  LD   IX,L5FF4	XOR  A	LD   C,#61	RST  #10L5F64  LD   HL,L6000    ; вывод текста основного окна (меню)	LD   C,#67	RST  #10	LD   A,#3	LD   B,(IX-#C)       LD   C,#63       ; подсветка строки	RST  #10       RET; процедура проверки отмеченных в панели файлов; выход - A-номер файла в каталоге для удаления или C-файл не найденL5F73  LD   B,A         ; A=2 на входе при удалении каталога       OR   A           ; проверяем на 0       SCF       RET  Z           ; если 0, то взвращаемся       LD   A,(L5F8C)   ; при удалении каталога в этих переменных нули	LD   E,AL5F7B	LD   A,(L5F8D)       CP   E           ; сравнили две переменные, если первая больше, возвращаемся	RET  C       LD   C,#86       ; получаем по номеру файла в панели (0) порядковый номер отметки	RST  #10       EXX	DEC  HL       LD   A,(HL)      ; читаем порядковый номер отметки (#00)       EXX	CP   B	RET  Z       INC  E           ; в E видимо считаем отметки файлов	JR   L5F7BL5F8C  DEFB #00         ; здесь будут минимальный и максимальный номера файлов в панелиL5F8D  DEFB #00L5F8E	LD   C,#8	RST  #10	DEC  C	RST  #10       RETL5F94	DEFB	#20	DEFB	#20	DEFB	#20	DEFB	#20	DEFB	#20	DEFB	#20	DEFB	#20	DEFB	#20	DEFB	#20	DEFB	#20	DEFB	#20	DEFB	#20L5FA0	DEFB	#02	DEFB	#11	DEFB	#03	DEFB	#0C	DEFB	#00L5FA5	DEFB	#00L5FA6	DEFB	#05	DEFB	#0CL5FA8	DEFB	#02	DEFB	#14	DEFB	#03	DEFB	#0C	DEFB	#07	DEFB	#FFL5FAE	DEFB	#04	DEFB	#0E	DEFB	#44	DEFB	#65	DEFB	#6C	DEFB	#65	DEFB	#74	DEFB	#65	DEFB	#20	DEFB	#3C	DEFB	#59	DEFB	#2F	DEFB	#4E	DEFB	#3E	DEFB	#20	DEFB	#3FL5FBE	DEFB	#02	DEFB	#0A	DEFB	#03	DEFB	#0C	DEFB	#07	DEFB	#FFL5FC4	DEFB	#04	DEFB	#0E	DEFB	#50	DEFB	#72	DEFB	#6F	DEFB	#74	DEFB	#65	DEFB	#63	DEFB	#74	DEFB	#65	DEFB	#64	DEFB	#20	DEFB	#66	DEFB	#69	DEFB	#6C	DEFB	#65L5FD4	DEFB	#4E	DEFB	#6F	DEFB	#74	DEFB	#20	DEFB	#65	DEFB	#6D	DEFB	#70	DEFB	#74	DEFB	#79	DEFB	#20	DEFB	#63	DEFB	#61	DEFB	#74	DEFB	#20L5FE2  DEFW L6054;       DEFB #60       DEFW L5EB0;       DEFB #5E       DEFW L5EB0;       DEFB #5E       DEFB #00         ; цвет курсора при нажатии Enter       DEFB #00         ; управляющий регистр меню       DEFB #00         ; цвет курсора       DEFB #03         ; позиция курсора       DEFW #0000         ; адрес программы инициализации символьного массива       DEFW #0000         ; адрес програмы пользователя при нажатии любой клавиши       DEFW #0000         ; адрес списка функций горячих клавиш;       DEFB #E2         ; адрес списка функций по Enter;       DEFB #5F       DEFW L5FE2L5FF4  DEFB #02	DEFB	#0A	DEFB	#06	DEFB	#0CL5FF8	DEFB	#07	DEFB	#FFL5FFA	DEFB	#05	DEFB	#0A	DEFB	#01	DEFB	#01	DEFB	#01	DEFB	#00L6000	DEFB	#51	DEFB	#75	DEFB	#69	DEFB	#74	DEFB	#0D       DEFB #41	DEFB	#73	DEFB	#6B	DEFB	#20	DEFB	#44	DEFB	#65	DEFB	#6C	DEFB	#65	DEFB	#74	DEFB	#65	DEFB	#0D	DEFB	#44	DEFB	#65	DEFB	#6C	DEFB	#65	DEFB	#74	DEFB	#65	DEFB	#0D	DEFB	#53	DEFB	#65	DEFB	#6C	DEFB	#65	DEFB	#63	DEFB	#74	DEFB	#3AL601E	DEFB	#20	DEFB	#20	DEFB	#20	DEFB	#03L6022  LD   DE,0         ; в DE будет #0001L6023	EQU	$-#2	XOR  A	LD   A,#3       LD   BC,#0A7C      ; преобразуем DE в текст в HL A-длина выходного буфера	LD   HL,L601E	RST  #10	LD   IX,L5FF4       LD   HL,(L5DCA)   ; расстановки цветов	LD   (L5FF8),HL	LD   A,H	LD   (L5FA5),A	LD   HL,(L5DCC)	LD   (IX-#A),L	LD   (IX-#C),H	XOR  A	LD   C,#61	RST  #10       LD   A,#0         ; сюда сохраняем ключ, но должно быть 0L604B	EQU	$-#1	OR   A       JP   NZ,L5EAD     ; если был ключ, то переходим       LD   C,#91        ; вывод меню	RST  #10	RET  CL6054  LD   SP,0         ; процедура выхода из менюL6055	EQU	$-#2	LD   A,#0L6058	EQU	$-#1	OR   A	JR   NZ,L605F	LD   A,#F8L605D	EQU	$-#1       RETL605F	LD   C,#83	RST  #10       RETL6063	LD   IX,L5FA8	LD   A,(L5DCF)	LD   (IX+#4),A	XOR  A	LD   C,#61	RST  #10	LD   C,#66	RST  #10L6074  CALL L5F8E       ; ждём нажатия клавиши	CP   #10       JR   Z,L6054     ; выход по SS+A	CP   #79       SCF       RET  Z           ; если нажато #79, возврат с поднятым флагом C	CP   #6E	JR   NZ,L6074	OR   A       RET              ; по нажатию #6E возврат с Z,NCL6085  EQU  $           ; #6085L6091  EQU  $+12        ; #6091